# Editor ç»„ä»¶å…¨é¢é‡æ„æ–¹æ¡ˆ

## ç›®å½•

1. [æ‰§è¡Œæ‘˜è¦](#æ‰§è¡Œæ‘˜è¦)
2. [å½“å‰é—®é¢˜åˆ†æ](#å½“å‰é—®é¢˜åˆ†æ)
3. [é‡æ„ç›®æ ‡ä¸åŸåˆ™](#é‡æ„ç›®æ ‡ä¸åŸåˆ™)
4. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
5. [æ’ä»¶ç³»ç»Ÿè®¾è®¡](#æ’ä»¶ç³»ç»Ÿè®¾è®¡)
6. [é…ç½®ç³»ç»Ÿè®¾è®¡](#é…ç½®ç³»ç»Ÿè®¾è®¡)
7. [ä¸»é¢˜ç³»ç»Ÿè®¾è®¡](#ä¸»é¢˜ç³»ç»Ÿè®¾è®¡)
8. [ç»„ä»¶é‡æ„æ–¹æ¡ˆ](#ç»„ä»¶é‡æ„æ–¹æ¡ˆ)
9. [åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
10. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
11. [é£é™©ç®¡ç†](#é£é™©ç®¡ç†)
12. [æˆåŠŸæ ‡å‡†](#æˆåŠŸæ ‡å‡†)

---

## æ‰§è¡Œæ‘˜è¦

### é‡æ„æ¦‚è¿°

æœ¬é‡æ„æ–¹æ¡ˆæ—¨åœ¨å°† Editor ç»„ä»¶æ”¹é€ ä¸ºä¸€ä¸ª**é«˜åº¦å¯å¤ç”¨ã€å¯æ‰©å±•ã€å¯é…ç½®**çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç»„ä»¶ã€‚åŸºäº **Next.js + Tailwind CSS** æŠ€æœ¯æ ˆï¼Œé‡æ„åå°†å…·å¤‡ï¼š

- **æ’ä»¶åŒ–æ¶æ„**ï¼šæ”¯æŒåŠŸèƒ½æ‰©å±•å’Œç¬¬ä¸‰æ–¹æ’ä»¶é›†æˆ
- **é«˜åº¦å¯é…ç½®**ï¼šå·¥å…·æ ã€å¿«æ·é”®ã€åŠŸèƒ½é™åˆ¶ç­‰å®Œå…¨å¯é…ç½®
- **ä¸»é¢˜ç³»ç»Ÿ**ï¼šåŸºäº Tailwind çš„ä¸»é¢˜åˆ‡æ¢å’Œè‡ªå®šä¹‰æ ·å¼
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **å®Œå–„çš„æµ‹è¯•**ï¼šä¿æŒç°æœ‰çš„ 209 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### é¢„æœŸæ”¶ç›Š

| æ”¶ç›Šé¡¹ | å½“å‰çŠ¶æ€ | é‡æ„å | æå‡ |
|--------|----------|--------|------|
| å¯æ‰©å±•æ€§ | æ— æ’ä»¶ç³»ç»Ÿ | æ’ä»¶åŒ–æ¶æ„ | è´¨çš„é£è·ƒ |
| å¯é…ç½®æ€§ | ç¡¬ç¼–ç é…ç½® | å®Œå…¨å¯é…ç½® | 90% |
| ä»£ç å¤ç”¨ç‡ | ä»…é™å•ä¸€åœºæ™¯ | é¡¹ç›®å†…å¤šåœºæ™¯å¤ç”¨ | 80% |
| ç»´æŠ¤æˆæœ¬ | é«˜ï¼ˆè€¦åˆé‡ï¼‰ | ä½ï¼ˆæ¨¡å—åŒ–ï¼‰ | é™ä½ 60% |
| ä¸»é¢˜å®šåˆ¶ | å›°éš¾ | åŸºäº Tailwind æ˜“äºå®šåˆ¶ | 70% |

### æ—¶é—´ä¼°ç®—

- **æ€»æ—¶é—´**ï¼šçº¦ 90 å°æ—¶
- **é˜¶æ®µæ•°**ï¼š5 ä¸ªä¸»è¦é˜¶æ®µ
- **å›¢é˜Ÿé…ç½®**ï¼š1-2 åå¼€å‘è€…
- **å»ºè®®å‘¨æœŸ**ï¼š4-6 å‘¨

---

## å½“å‰é—®é¢˜åˆ†æ

### 1. é…ç½®çµæ´»æ€§ä¸è¶³

#### 1.1 ç¡¬ç¼–ç é…ç½®

**é—®é¢˜ç¤ºä¾‹ï¼š**
```typescript
// å½“å‰ç¡¬ç¼–ç çš„é…ç½®
const DEFAULT_FONT_SIZES = ['1', '2', '3', '4', '5', '6', '7']  // âŒ
const MAX_TABLE_SIZE = 10  // âŒ
const MAX_IMAGE_SIZE = 5 * 1024 * 1024  // âŒ
const DEFAULT_COLORS = [  // âŒ
  '#000000', '#FFFFFF', '#FF0000', ...
]
```

**å½±å“ï¼š**
- æ— æ³•æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é™åˆ¶
- ä¸åŒåœºæ™¯éœ€è¦ä¿®æ”¹æºç 
- éš¾ä»¥è¿›è¡Œ A/B æµ‹è¯•

#### 1.2 å·¥å…·æ å¸ƒå±€å›ºå®š

**é—®é¢˜ï¼š**
```typescript
// å·¥å…·æ å¸ƒå±€å†™æ­»
const TOOLBAR_LAYOUT = [
  ['undo', 'redo'],
  ['bold', 'italic', 'underline'],
  // ... å›ºå®šé¡ºåº
]
```

**å½±å“ï¼š**
- æ— æ³•è‡ªå®šä¹‰æŒ‰é’®é¡ºåº
- æ— æ³•éšè—ä¸éœ€è¦çš„åŠŸèƒ½
- æ— æ³•æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®

### 2. ç¼ºå°‘æ’ä»¶ç³»ç»Ÿ

**é—®é¢˜è¡¨ç°ï¼š**
- æ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç 
- æ— æ³•é›†æˆç¬¬ä¸‰æ–¹æ’ä»¶
- åŠŸèƒ½æ‰©å±•å›°éš¾

**ç¤ºä¾‹åœºæ™¯ï¼š**
```typescript
// æƒ³æ·»åŠ "ä»£ç é«˜äº®"åŠŸèƒ½ï¼Œéœ€è¦ï¼š
// 1. ä¿®æ”¹ EditablePreview.tsx (1140 è¡Œ)
// 2. ä¿®æ”¹ useEditorCommands.ts (404 è¡Œ)
// 3. ä¿®æ”¹ EditorToolbar.tsx (386 è¡Œ)
// 4. æ·»åŠ é…ç½®æ–‡ä»¶
// é£é™©é«˜ã€å·¥ä½œé‡å¤§ã€éš¾ä»¥ç»´æŠ¤
```

### 3. ä»£ç ç»„ç»‡é—®é¢˜

**é—®é¢˜è¡¨ç°ï¼š**
- ç»„ä»¶ä¹‹é—´è€¦åˆè¾ƒé‡
- çŠ¶æ€åˆ†æ•£åœ¨å¤šä¸ª useState
- é€»è¾‘å¤ç”¨å›°éš¾

**ç¤ºä¾‹ï¼š**
```typescript
// EditablePreview.tsx ä¸­æœ‰ 10+ ä¸ª useState
const [isEditing, setIsEditing] = useState(false)
const [selectedImage, setSelectedImage] = useState(null)
const [activeTable, setActiveTable] = useState(null)
// ... çŠ¶æ€åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
```

---

## é‡æ„ç›®æ ‡ä¸åŸåˆ™

### é‡æ„ç›®æ ‡

#### ä¸»è¦ç›®æ ‡ï¼ˆMust Haveï¼‰

1. **å®ç°æ’ä»¶ç³»ç»Ÿ**
   - è®¾è®¡æ’ä»¶ API
   - æä¾›ç”Ÿå‘½å‘¨æœŸé’©å­
   - æ”¯æŒäº‹ä»¶ç³»ç»Ÿ
   - å…è®¸åŠ¨æ€æ³¨å†Œå‘½ä»¤å’Œå·¥å…·æ æŒ‰é’®

2. **é«˜åº¦å¯é…ç½®**
   - å·¥å…·æ å®Œå…¨å¯é…ç½®ï¼ˆé¡ºåºã€æ˜¾ç¤º/éšè—ï¼‰
   - å¿«æ·é”®å¯è‡ªå®šä¹‰
   - åŠŸèƒ½é™åˆ¶å¯è°ƒæ•´ï¼ˆå›¾ç‰‡å¤§å°ã€è¡¨æ ¼å°ºå¯¸ç­‰ï¼‰
   - æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°

3. **ä»£ç æ¨¡å—åŒ–**
   - æ ¸å¿ƒå¼•æ“æŠ½è±¡ï¼ˆå‘½ä»¤ç®¡ç†ã€çŠ¶æ€ç®¡ç†ã€å†å²ç®¡ç†ï¼‰
   - ç»„ä»¶è§£è€¦ï¼Œé™ä½è€¦åˆåº¦
   - æå‡ä»£ç å¤ç”¨æ€§

4. **ä¸»é¢˜ç³»ç»Ÿ**
   - åŸºäº Tailwind çš„ä¸»é¢˜é…ç½®
   - æ”¯æŒæš—è‰²æ¨¡å¼
   - æ”¯æŒè‡ªå®šä¹‰é¢œè‰²æ–¹æ¡ˆ

#### æ¬¡è¦ç›®æ ‡ï¼ˆShould Haveï¼‰

5. **æ€§èƒ½ä¼˜åŒ–**
   - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ–‡æ¡£ï¼‰
   - æ‡’åŠ è½½ç»„ä»¶
   - ä¼˜åŒ–é‡æ¸²æŸ“

6. **TypeScript å¼ºåŒ–**
   - å®Œæ•´çš„ç±»å‹å®šä¹‰
   - æ³›å‹æ”¯æŒ
   - ç±»å‹æ¨å¯¼

7. **æ–‡æ¡£å®Œå–„**
   - API æ–‡æ¡£
   - ä½¿ç”¨ç¤ºä¾‹
   - æœ€ä½³å®è·µ

#### é™„åŠ ç›®æ ‡ï¼ˆNice to Haveï¼‰

8. **è¾…åŠ©åŠŸèƒ½**
   - ARIA å±æ€§
   - é”®ç›˜å¯¼èˆª
   - å±å¹•é˜…è¯»å™¨æ”¯æŒ

### è®¾è®¡åŸåˆ™

1. **æ¸è¿›å¢å¼º**ï¼šç¡®ä¿åŸºç¡€åŠŸèƒ½åœ¨ä»»ä½•ç¯å¢ƒä¸‹å¯ç”¨
2. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½
3. **æµ‹è¯•é©±åŠ¨**ï¼šæ¯ä¸ªé‡æ„éƒ½æœ‰æµ‹è¯•ä¿æŠ¤
4. **æ–‡æ¡£å…ˆè¡Œ**ï¼šAPI è®¾è®¡å…ˆäºå®ç°
5. **æ€§èƒ½ä¼˜å…ˆ**ï¼šä¸å› æ¶æ„ç‰ºç‰²æ€§èƒ½

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Editor ç»„ä»¶                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   Core Engine                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Command   â”‚  â”‚    State     â”‚  â”‚   History   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Manager   â”‚  â”‚   Manager    â”‚  â”‚   Manager   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â†•                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  Plugin System                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Plugin    â”‚  â”‚    Event     â”‚  â”‚   Hook      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Registry  â”‚  â”‚    Bus       â”‚  â”‚  System     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â†•                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                 UI Components                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Toolbar   â”‚  â”‚   Editor     â”‚  â”‚    Status   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Builder   â”‚  â”‚    Area      â”‚  â”‚    Bar      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â†•                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Configuration & Theme                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Config    â”‚  â”‚    Theme     â”‚  â”‚   I18n      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   Manager   â”‚  â”‚   Provider   â”‚  â”‚  Provider   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Storage Abstraction                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Memory    â”‚  â”‚   Local      â”‚  â”‚   Remote    â”‚        â”‚
â”‚  â”‚   Storage   â”‚  â”‚   Storage    â”‚  â”‚   Storage   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 1. Core Engineï¼ˆæ ¸å¿ƒå¼•æ“ï¼‰

**èŒè´£ï¼š**
- ç¼–è¾‘å‘½ä»¤æ‰§è¡Œ
- çŠ¶æ€ç®¡ç†
- å†å²è®°å½•ç®¡ç†

**æ¥å£è®¾è®¡ï¼š**
```typescript
// core/CommandManager.ts
interface CommandManager {
  // æ‰§è¡Œå‘½ä»¤
  execute(command: string, ...args: any[]): void

  // æ³¨å†Œè‡ªå®šä¹‰å‘½ä»¤
  registerCommand(name: string, handler: CommandHandler): void

  // æ£€æŸ¥å‘½ä»¤çŠ¶æ€
  queryState(command: string): boolean

  // æ£€æŸ¥å‘½ä»¤å€¼
  queryValue(command: string): string
}

interface CommandHandler {
  (doc: Document, ...args: any[]): void
}
```

```typescript
// core/StateManager.ts
interface StateManager {
  // è·å–å½“å‰çŠ¶æ€
  getState(): EditorState

  // æ›´æ–°çŠ¶æ€
  setState(partial: Partial<EditorState>): void

  // è®¢é˜…çŠ¶æ€å˜åŒ–
  subscribe(listener: StateListener): () => void
}

interface EditorState {
  content: string
  selection: Selection | null
  floatingImages: FloatingImageItem[]
  activeTable: HTMLTableElement | null
  isEditing: boolean
  // ... å…¶ä»–çŠ¶æ€
}
```

```typescript
// core/HistoryManager.ts
interface HistoryManager {
  // ä¿å­˜å½“å‰çŠ¶æ€
  push(state: EditorState): void

  // æ’¤é”€
  undo(): EditorState | null

  // é‡åš
  redo(): EditorState | null

  // æ£€æŸ¥æ˜¯å¦å¯æ’¤é”€
  canUndo(): boolean

  // æ£€æŸ¥æ˜¯å¦å¯é‡åš
  canRedo(): boolean

  // æ¸…ç©ºå†å²
  clear(): void
}
```

#### 2. Plugin Systemï¼ˆæ’ä»¶ç³»ç»Ÿï¼‰

**æ’ä»¶æ¥å£ï¼š**
```typescript
// plugin/Plugin.ts
interface Plugin {
  // æ’ä»¶åç§°
  name: string

  // æ’ä»¶ç‰ˆæœ¬
  version: string

  // æ’ä»¶ä¾èµ–
  dependsOn?: string[]

  // åˆå§‹åŒ–
  init(editor: EditorAPI): void | Promise<void>

  // é”€æ¯
  destroy(): void

  // é…ç½®é€‰é¡¹
  config?: PluginConfig

  // æ‰©å±•ç‚¹
  extends?: {
    commands?: Record<string, CommandHandler>
    toolbar?: ToolbarExtension
    shortcuts?: ShortcutConfig[]
    hooks?: HookRegistry
  }
}

// æ’ä»¶ API
interface EditorAPI {
  commands: CommandManager
  state: StateManager
  history: HistoryManager
  events: EventBus
  config: ConfigManager
  theme: ThemeManager
}
```

**äº‹ä»¶ç³»ç»Ÿï¼š**
```typescript
// plugin/EventBus.ts
interface EventBus {
  // è®¢é˜…äº‹ä»¶
  on(event: string, handler: EventHandler): () => void

  // è®¢é˜…ä¸€æ¬¡
  once(event: string, handler: EventHandler): () => void

  // å–æ¶ˆè®¢é˜…
  off(event: string, handler: EventHandler): void

  // è§¦å‘äº‹ä»¶
  emit(event: string, ...args: any[]): void

  // æ‰¹é‡è§¦å‘
  emitBatch(events: Array<{event: string, args: any[]}>): void
}

// å†…ç½®äº‹ä»¶ç±»å‹
type EditorEvent =
  | 'content-change'
  | 'selection-change'
  | 'before-command'
  | 'after-command'
  | 'image-insert'
  | 'table-insert'
  | 'floating-image-insert'
  | 'state-restore'
  | 'plugin-load'
  | 'plugin-unload'
```

**ç”Ÿå‘½å‘¨æœŸé’©å­ï¼š**
```typescript
// plugin/HookRegistry.ts
interface HookRegistry {
  // å†…å®¹æ”¹å˜å‰
  beforeContentChange: AsyncSeriesHook<ContentChangeContext>

  // å†…å®¹æ”¹å˜å
  afterContentChange: AsyncSeriesHook<ContentChangeContext>

  // å‘½ä»¤æ‰§è¡Œå‰
  beforeCommand: AsyncWaterfallHook<CommandContext>

  // å‘½ä»¤æ‰§è¡Œå
  afterCommand: AsyncSeriesHook<CommandContext>

  // æ’ä»¶åŠ è½½å‰
  beforePluginLoad: AsyncWaterfallHook<Plugin>

  // æ’ä»¶åŠ è½½å
  afterPluginLoad: AsyncSeriesHook<Plugin>
}

// Hook ç±»å‹
type AsyncSeriesHook<T> = (context: T) => Promise<void>
type AsyncWaterfallHook<T> = (context: T) => Promise<T>
```

#### 3. Configuration Systemï¼ˆé…ç½®ç³»ç»Ÿï¼‰

**é…ç½®æ¥å£ï¼š**
```typescript
// config/EditorConfig.ts
interface EditorConfig {
  // åŸºç¡€é…ç½®
  locale: string
  readonly: boolean
  spellcheck: boolean

  // å†…å®¹é…ç½®
  content: {
    initialContent: string
    placeholder: string
    sanitize: boolean
    allowedTags: string[]
    allowedAttributes: Record<string, string[]>
  }

  // å·¥å…·æ é…ç½®
  toolbar: ToolbarConfig

  // å¿«æ·é”®é…ç½®
  shortcuts: ShortcutConfig[]

  // å›¾ç‰‡é…ç½®
  image: {
    maxSize: number // bytes
    maxWidth: number // px
    maxHeight: number // px
    defaultWidth: number
    defaultHeight: number
    resizeHandles: 'all' | 'corners' | 'disabled'
  }

  // è¡¨æ ¼é…ç½®
  table: {
    maxSize: { rows: number, cols: number }
    defaultSize: { rows: number, cols: number }
    resizeEnabled: boolean
    mergeEnabled: boolean
    splitEnabled: boolean
  }

  // æµ®åŠ¨å›¾ç‰‡é…ç½®
  floatingImage: {
    enabled: boolean
    defaultWidth: number
    defaultHeight: number
    minSize: number
    maxSize: number
  }

  // å†å²é…ç½®
  history: {
    maxSize: number
    debounceDelay: number
  }

  // å­˜å‚¨é…ç½®
  storage: StorageConfig

  // ä¸»é¢˜é…ç½®
  theme: ThemeConfig

  // æ’ä»¶é…ç½®
  plugins: PluginConfig[]
}

// å·¥å…·æ é…ç½®
interface ToolbarConfig {
  // å·¥å…·æ ä½ç½®
  position: 'top' | 'bottom' | 'floating'

  // å·¥å…·æ è¡Œ
  rows: ToolbarRow[]

  // è‡ªå®šä¹‰æŒ‰é’®
  customButtons: CustomButton[]
}

interface ToolbarRow {
  groups: ToolbarGroup[]
}

interface ToolbarGroup {
  id: string
  items: ToolbarItem[]
  separator?: boolean
}

type ToolbarItem =
  | ToolbarButton
  | ToolbarSelect
  | ToolbarColorPicker
  | ToolbarDropdown

interface ToolbarButton {
  type: 'button'
  id: string
  icon: React.ComponentType | string
  tooltip: string
  command: string
  commandArgs?: any[]
  disabled?: boolean
  active?: (state: EditorState) => boolean
}

interface ToolbarSelect {
  type: 'select'
  id: string
  items: Array<{value: string, label: string}>
  defaultValue: string
  command: string
  onChange?: (value: string) => void
}

// å¿«æ·é”®é…ç½®
interface ShortcutConfig {
  key: string
  command: string
  commandArgs?: any[]
  preventDefault?: boolean
}
```

**é…ç½®ç®¡ç†å™¨ï¼š**
```typescript
// config/ConfigManager.ts
interface ConfigManager {
  // è·å–é…ç½®
  get<K extends keyof EditorConfig>(key: K): EditorConfig[K]

  // è®¾ç½®é…ç½®
  set<K extends keyof EditorConfig>(
    key: K,
    value: EditorConfig[K]
  ): void

  // åˆå¹¶é…ç½®
  merge(config: Partial<EditorConfig>): void

  // é‡ç½®ä¸ºé»˜è®¤é…ç½®
  reset(): void

  // éªŒè¯é…ç½®
  validate(config: Partial<EditorConfig>): ValidationResult
}
```

#### 4. Theme Systemï¼ˆä¸»é¢˜ç³»ç»Ÿï¼‰

**ä¸»é¢˜æ¥å£ï¼š**
```typescript
// theme/Theme.ts
interface Theme {
  name: string

  // é¢œè‰²å˜é‡
  colors: {
    primary: string
    secondary: string
    background: string
    surface: string
    border: string
    text: string
    textSecondary: string
    error: string
    warning: string
    success: string
    info: string
  }

  // å­—ä½“å˜é‡
  typography: {
    fontFamily: string
    fontSize: {
      xs: string
      sm: string
      md: string
      lg: string
      xl: string
    }
    fontWeight: {
      normal: number
      medium: number
      semibold: number
      bold: number
    }
    lineHeight: {
      tight: number
      normal: number
      relaxed: number
    }
  }

  // é—´è·å˜é‡
  spacing: {
    xs: string
    sm: string
    md: string
    lg: string
    xl: string
  }

  // åœ†è§’å˜é‡
  borderRadius: {
    sm: string
    md: string
    lg: string
    full: string
  }

  // é˜´å½±å˜é‡
  shadows: {
    sm: string
    md: string
    lg: string
    xl: string
  }

  // è¿‡æ¸¡å˜é‡
  transitions: {
    fast: string
    normal: string
    slow: string
  }

  // ç»„ä»¶ç‰¹å®šæ ·å¼
  components: {
    toolbar: ToolbarTheme
    button: ButtonTheme
    input: InputTheme
    dropdown: DropdownTheme
    modal: ModalTheme
  }
}

interface ToolbarTheme {
  background: string
  border: string
  padding: string
  gap: string
  height: string
}

interface ButtonTheme {
  primary: ButtonVariantTheme
  secondary: ButtonVariantTheme
  ghost: ButtonVariantTheme
}

interface ButtonVariantTheme {
  background: string
  color: string
  hoverBackground: string
  activeBackground: string
  disabledBackground: string
  disabledColor: string
}
```

**ä¸»é¢˜ç®¡ç†å™¨ï¼š**
```typescript
// theme/ThemeManager.ts
interface ThemeManager {
  // è®¾ç½®ä¸»é¢˜
  setTheme(theme: Theme | string): void

  // è·å–å½“å‰ä¸»é¢˜
  getTheme(): Theme

  // æ³¨å†Œä¸»é¢˜
  registerTheme(theme: Theme): void

  // è·å– CSS å˜é‡
  getCSSVariables(): Record<string, string>

  // åˆ‡æ¢æš—è‰²æ¨¡å¼
  toggleDarkMode(): void

  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  onChange(listener: (theme: Theme) => void): () => void
}
```

#### 5. Storage Abstractionï¼ˆå­˜å‚¨æŠ½è±¡ï¼‰

**å­˜å‚¨æ¥å£ï¼š**
```typescript
// storage/Storage.ts
interface Storage {
  // ä¿å­˜æ•°æ®
  set(key: string, value: any): Promise<void>

  // è·å–æ•°æ®
  get<T>(key: string): Promise<T | null>

  // åˆ é™¤æ•°æ®
  remove(key: string): Promise<void>

  // æ¸…ç©ºæ•°æ®
  clear(): Promise<void>

  // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
  has(key: string): Promise<boolean>

  // è·å–æ‰€æœ‰é”®
  keys(): Promise<string[]>
}

// å†…å­˜å­˜å‚¨
class MemoryStorage implements Storage {
  private store = new Map<string, any>()

  async set(key: string, value: any): Promise<void> {
    this.store.set(key, value)
  }

  async get<T>(key: string): Promise<T | null> {
    return this.store.get(key) ?? null
  }

  async remove(key: string): Promise<void> {
    this.store.delete(key)
  }

  async clear(): Promise<void> {
    this.store.clear()
  }

  async has(key: string): Promise<boolean> {
    return this.store.has(key)
  }

  async keys(): Promise<string[]> {
    return Array.from(this.store.keys())
  }
}

// LocalStorage é€‚é…å™¨
class LocalStorageAdapter implements Storage {
  async set(key: string, value: any): Promise<void> {
    const serialized = JSON.stringify(value)
    localStorage.setItem(key, serialized)
  }

  async get<T>(key: string): Promise<T | null> {
    const serialized = localStorage.getItem(key)
    if (serialized === null) return null
    try {
      return JSON.parse(serialized) as T
    } catch {
      return null
    }
  }

  async remove(key: string): Promise<void> {
    localStorage.removeItem(key)
  }

  async clear(): Promise<void> {
    localStorage.clear()
  }

  async has(key: string): Promise<boolean> {
    return localStorage.getItem(key) !== null
  }

  async keys(): Promise<string[]> {
    return Object.keys(localStorage)
  }
}

// IndexedDB é€‚é…å™¨
class IndexedDBAdapter implements Storage {
  private db: IDBDatabase | null = null
  private dbName = 'editor-storage'
  private storeName = 'key-value'

  async init(): Promise<void> {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open(this.dbName, 1)

      request.onerror = () => reject(request.error)
      request.onsuccess = () => {
        this.db = request.result
        resolve()
      }

      request.onupgradeneeded = () => {
        const db = request.result
        if (!db.objectStoreNames.contains(this.storeName)) {
          db.createObjectStore(this.storeName)
        }
      }
    })
  }

  async set(key: string, value: any): Promise<void> {
    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(this.storeName, 'readwrite')
      const store = transaction.objectStore(this.storeName)
      const request = store.put(value, key)

      request.onsuccess = () => resolve()
      request.onerror = () => reject(request.error)
    })
  }

  async get<T>(key: string): Promise<T | null> {
    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(this.storeName, 'readonly')
      const store = transaction.objectStore(this.storeName)
      const request = store.get(key)

      request.onsuccess = () => resolve(request.result ?? null)
      request.onerror = () => reject(request.error)
    })
  }

  async remove(key: string): Promise<void> {
    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(this.storeName, 'readwrite')
      const store = transaction.objectStore(this.storeName)
      const request = store.delete(key)

      request.onsuccess = () => resolve()
      request.onerror = () => reject(request.error)
    })
  }

  async clear(): Promise<void> {
    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(this.storeName, 'readwrite')
      const store = transaction.objectStore(this.storeName)
      const request = store.clear()

      request.onsuccess = () => resolve()
      request.onerror = () => reject(request.error)
    })
  }

  async has(key: string): Promise<boolean> {
    const value = await this.get(key)
    return value !== null
  }

  async keys(): Promise<string[]> {
    if (!this.db) await this.init()

    return new Promise((resolve, reject) => {
      const transaction = this.db!.transaction(this.storeName, 'readonly')
      const store = transaction.objectStore(this.storeName)
      const request = store.getAllKeys()

      request.onsuccess = () => resolve(request.result as string[])
      request.onerror = () => reject(request.error)
    })
  }
}

// è¿œç¨‹å­˜å‚¨é€‚é…å™¨
interface RemoteStorageOptions {
  baseUrl: string
  headers?: Record<string, string>
  timeout?: number
}

class RemoteStorageAdapter implements Storage {
  private options: RemoteStorageOptions

  constructor(options: RemoteStorageOptions) {
    this.options = options
  }

  private async request<T>(
    endpoint: string,
    options?: RequestInit
  ): Promise<T> {
    const url = `${this.options.baseUrl}${endpoint}`
    const response = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...this.options.headers,
        ...options?.headers
      },
      signal: AbortSignal.timeout(this.options.timeout ?? 5000)
    })

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`)
    }

    return response.json()
  }

  async set(key: string, value: any): Promise<void> {
    await this.request(`/storage/${key}`, {
      method: 'PUT',
      body: JSON.stringify(value)
    })
  }

  async get<T>(key: string): Promise<T | null> {
    try {
      return await this.request<T>(`/storage/${key}`, {
        method: 'GET'
      })
    } catch (error) {
      if (error instanceof Error && error.message.includes('404')) {
        return null
      }
      throw error
    }
  }

  async remove(key: string): Promise<void> {
    await this.request(`/storage/${key}`, {
      method: 'DELETE'
    })
  }

  async clear(): Promise<void> {
    await this.request('/storage', {
      method: 'DELETE'
    })
  }

  async has(key: string): Promise<boolean> {
    try {
      await this.get(key)
      return true
    } catch {
      return false
    }
  }

  async keys(): Promise<string[]> {
    return this.request<string[]>('/storage/keys', {
      method: 'GET'
    })
  }
}
```

---

## æ’ä»¶ç³»ç»Ÿè®¾è®¡

### æ’ä»¶ API è®¾è®¡

#### 1. åŸºç¡€æ’ä»¶æ¥å£

```typescript
// plugin/types.ts
export interface Plugin<
  TConfig extends Record<string, any> = any
> {
  // æ’ä»¶å…ƒä¿¡æ¯
  name: string
  version: string
  description?: string
  author?: string

  // ä¾èµ–ç®¡ç†
  dependencies?: string[]
  peerDependencies?: string[]

  // é…ç½® schemaï¼ˆç”¨äºéªŒè¯ï¼‰
  configSchema?: object

  // ç”Ÿå‘½å‘¨æœŸé’©å­
  install: (api: EditorAPI, config?: TConfig) => void | Promise<void>
  uninstall?: () => void | Promise<void>

  // æ’ä»¶æ¿€æ´»æ—¶
  activate?: () => void | Promise<void>

  // æ’ä»¶åœç”¨æ—¶
  deactivate?: () => void | Promise<void>

  // æ‰©å±•ç‚¹
  extends?: PluginExtensions
}

export interface PluginExtensions {
  // è‡ªå®šä¹‰å‘½ä»¤
  commands?: Record<string, CommandExtension>

  // å·¥å…·æ æ‰©å±•
  toolbar?: ToolbarExtension

  // å¿«æ·é”®æ‰©å±•
  shortcuts?: ShortcutExtension[]

  // äº‹ä»¶ç›‘å¬å™¨
  eventListeners?: EventListenerExtension[]

  // ç”Ÿå‘½å‘¨æœŸé’©å­
  hooks?: HookExtension
}

export interface CommandExtension {
  execute: (doc: Document, ...args: any[]) => void
  queryState?: () => boolean
  queryValue?: () => string
}

export interface ToolbarExtension {
  position?: 'left' | 'right' | 'custom'
  groups?: ToolbarGroup[]
  buttons?: ToolbarButton[]
}

export interface ShortcutExtension {
  key: string
  command: string
  commandArgs?: any[]
}

export interface EventListenerExtension {
  event: string
  handler: (...args: any[]) => void
  priority?: number
}

export interface HookExtension {
  beforeContentChange?: (context: ContentChangeContext) => void | Promise<void>
  afterContentChange?: (context: ContentChangeContext) => void | Promise<void>
  beforeCommand?: (context: CommandContext) => CommandContext | Promise<CommandContext>
  afterCommand?: (context: CommandContext) => void | Promise<void>
}
```

#### 2. æ’ä»¶ç®¡ç†å™¨

```typescript
// plugin/PluginManager.ts
export class PluginManager {
  private plugins = new Map<string, PluginInstance>()
  private api: EditorAPI

  constructor(api: EditorAPI) {
    this.api = api
  }

  // æ³¨å†Œæ’ä»¶
  async register<TConfig extends Record<string, any>>(
    plugin: Plugin<TConfig>,
    config?: TConfig
  ): Promise<void> {
    // æ£€æŸ¥ä¾èµ–
    await this.checkDependencies(plugin)

    // åˆ›å»ºæ’ä»¶å®ä¾‹
    const instance: PluginInstance = {
      plugin,
      config,
      state: 'registered'
    }

    this.plugins.set(plugin.name, instance)

    // å®‰è£…æ’ä»¶
    await this.installPlugin(instance)

    // è§¦å‘æ’ä»¶åŠ è½½äº‹ä»¶
    this.api.events.emit('plugin-load', plugin)
  }

  // æ³¨é”€æ’ä»¶
  async unregister(name: string): Promise<void> {
    const instance = this.plugins.get(name)
    if (!instance) {
      throw new Error(`Plugin not found: ${name}`)
    }

    // åœç”¨æ’ä»¶
    if (instance.state === 'active') {
      await this.deactivatePlugin(instance)
    }

    // å¸è½½æ’ä»¶
    await this.uninstallPlugin(instance)

    // ç§»é™¤æ’ä»¶
    this.plugins.delete(name)

    // è§¦å‘æ’ä»¶å¸è½½äº‹ä»¶
    this.api.events.emit('plugin-unload', instance.plugin)
  }

  // æ¿€æ´»æ’ä»¶
  async activate(name: string): Promise<void> {
    const instance = this.plugins.get(name)
    if (!instance) {
      throw new Error(`Plugin not found: ${name}`)
    }

    if (instance.state !== 'registered') {
      throw new Error(`Plugin is not in registered state: ${name}`)
    }

    await instance.plugin.activate?.()
    instance.state = 'active'
  }

  // åœç”¨æ’ä»¶
  async deactivate(name: string): Promise<void> {
    const instance = this.plugins.get(name)
    if (!instance) {
      throw new Error(`Plugin not found: ${name}`)
    }

    if (instance.state !== 'active') {
      throw new Error(`Plugin is not in active state: ${name}`)
    }

    await this.deactivatePlugin(instance)
  }

  // è·å–æ’ä»¶
  getPlugin(name: string): Plugin | undefined {
    return this.plugins.get(name)?.plugin
  }

  // è·å–æ‰€æœ‰æ’ä»¶
  getAllPlugins(): Plugin[] {
    return Array.from(this.plugins.values()).map(p => p.plugin)
  }

  // æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²æ³¨å†Œ
  hasPlugin(name: string): boolean {
    return this.plugins.has(name)
  }

  // æ£€æŸ¥æ’ä»¶æ˜¯å¦å·²æ¿€æ´»
  isPluginActive(name: string): boolean {
    return this.plugins.get(name)?.state === 'active'
  }

  // ç§æœ‰æ–¹æ³•ï¼šå®‰è£…æ’ä»¶
  private async installPlugin(instance: PluginInstance): Promise<void> {
    const { plugin, config } = instance

    // è°ƒç”¨æ’ä»¶çš„ install æ–¹æ³•
    await plugin.install(this.api, config)

    // æ³¨å†Œæ‰©å±•
    if (plugin.extends) {
      await this.registerExtensions(plugin, plugin.extends)
    }

    instance.state = 'registered'
  }

  // ç§æœ‰æ–¹æ³•ï¼šå¸è½½æ’ä»¶
  private async uninstallPlugin(instance: PluginInstance): Promise<void> {
    const { plugin } = instance

    // è°ƒç”¨æ’ä»¶çš„ uninstall æ–¹æ³•
    await plugin.uninstall?.()

    // æ³¨é”€æ‰©å±•
    if (plugin.extends) {
      await this.unregisterExtensions(plugin, plugin.extends)
    }
  }

  // ç§æœ‰æ–¹æ³•ï¼šæ¿€æ´»æ’ä»¶
  private async deactivatePlugin(instance: PluginInstance): Promise<void> {
    await instance.plugin.deactivate?.()
    instance.state = 'registered'
  }

  // ç§æœ‰æ–¹æ³•ï¼šæ³¨å†Œæ‰©å±•
  private async registerExtensions(
    plugin: Plugin,
    extensions: PluginExtensions
  ): Promise<void> {
    // æ³¨å†Œå‘½ä»¤
    if (extensions.commands) {
      for (const [name, command] of Object.entries(extensions.commands)) {
        this.api.commands.registerCommand(name, command.execute)
      }
    }

    // æ³¨å†Œå·¥å…·æ 
    if (extensions.toolbar) {
      // TODO: å®ç°å·¥å…·æ æ‰©å±•æ³¨å†Œ
    }

    // æ³¨å†Œå¿«æ·é”®
    if (extensions.shortcuts) {
      for (const shortcut of extensions.shortcuts) {
        // TODO: å®ç°å¿«æ·é”®æ³¨å†Œ
      }
    }

    // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
    if (extensions.eventListeners) {
      for (const listener of extensions.eventListeners) {
        this.api.events.on(listener.event, listener.handler)
      }
    }

    // æ³¨å†Œé’©å­
    if (extensions.hooks) {
      // TODO: å®ç°é’©å­æ³¨å†Œ
    }
  }

  // ç§æœ‰æ–¹æ³•ï¼šæ³¨é”€æ‰©å±•
  private async unregisterExtensions(
    plugin: Plugin,
    extensions: PluginExtensions
  ): Promise<void> {
    // æ³¨é”€å‘½ä»¤
    if (extensions.commands) {
      for (const name of Object.keys(extensions.commands)) {
        this.api.commands.unregisterCommand(name)
      }
    }

    // æ³¨é”€äº‹ä»¶ç›‘å¬å™¨
    if (extensions.eventListeners) {
      for (const listener of extensions.eventListeners) {
        this.api.events.off(listener.event, listener.handler)
      }
    }
  }

  // ç§æœ‰æ–¹æ³•ï¼šæ£€æŸ¥ä¾èµ–
  private async checkDependencies(plugin: Plugin): Promise<void> {
    const { dependencies = [], peerDependencies = [] } = plugin

    // æ£€æŸ¥ dependencies
    for (const dep of dependencies) {
      if (!this.hasPlugin(dep)) {
        throw new Error(
          `Plugin "${plugin.name}" requires plugin "${dep}" to be installed first`
        )
      }
    }

    // æ£€æŸ¥ peerDependencies
    for (const dep of peerDependencies) {
      if (!this.hasPlugin(dep)) {
        console.warn(
          `Plugin "${plugin.name}" recommends plugin "${dep}" to be installed`
        )
      }
    }
  }
}

interface PluginInstance {
  plugin: Plugin
  config?: any
  state: 'registered' | 'active'
}
```

### æ’ä»¶ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šä»£ç é«˜äº®æ’ä»¶

```typescript
// plugins/CodeHighlightPlugin.ts
import { Plugin, EditorAPI } from '../types'

export const CodeHighlightPlugin: Plugin = {
  name: 'code-highlight',
  version: '1.0.0',
  description: 'Syntax highlighting for code blocks',
  author: 'Your Name',

  dependencies: [],

  async install(api: EditorAPI, config?: { theme: string }) {
    const theme = config?.theme || 'github'

    // æ³¨å†Œä»£ç å—é«˜äº®å‘½ä»¤
    api.commands.registerCommand('highlightCode', (doc) => {
      const codeBlocks = doc.querySelectorAll('pre code')
      codeBlocks.forEach((block) => {
        // åº”ç”¨é«˜äº®
        // ...
      })
    })

    // ç›‘å¬å†…å®¹å˜åŒ–
    api.events.on('content-change', () => {
      api.commands.execute('highlightCode')
    })

    // æ·»åŠ å·¥å…·æ æŒ‰é’®
    api.toolbar.addButton({
      id: 'highlight-code',
      icon: 'code',
      tooltip: 'Highlight Code',
      command: 'highlightCode'
    })
  },

  async uninstall(api: EditorAPI) {
    api.commands.unregisterCommand('highlightCode')
  },

  extends: {
    commands: {
      highlightCode: {
        execute: (doc) => {
          const codeBlocks = doc.querySelectorAll('pre code')
          codeBlocks.forEach((block) => {
            // åº”ç”¨é«˜äº®é€»è¾‘
          })
        }
      }
    }
  }
}
```

#### ç¤ºä¾‹ 2ï¼šå­—æ•°ç»Ÿè®¡æ’ä»¶

```typescript
// plugins/WordCountPlugin.ts
export const WordCountPlugin: Plugin = {
  name: 'word-count',
  version: '1.0.0',
  description: 'Count words and characters in the document',

  install(api: EditorAPI) {
    // æ·»åŠ çŠ¶æ€æ 
    const statusBar = document.createElement('div')
    statusBar.className = 'word-count-status'
    document.body.appendChild(statusBar)

    // æ›´æ–°å­—æ•°
    const updateCount = () => {
      const doc = api.state.getDocument()
      const text = doc.body.innerText
      const words = text.split(/\s+/).filter(w => w.length > 0).length
      const chars = text.length

      statusBar.textContent = `${words} words, ${chars} characters`
    }

    api.events.on('content-change', updateCount)

    // åˆå§‹æ›´æ–°
    updateCount()
  },

  uninstall() {
    const statusBar = document.querySelector('.word-count-status')
    statusBar?.remove()
  }
}
```

#### ç¤ºä¾‹ 3ï¼šè‡ªåŠ¨ä¿å­˜æ’ä»¶

```typescript
// plugins/AutoSavePlugin.ts
export const AutoSavePlugin: Plugin = {
  name: 'auto-save',
  version: '1.0.0',
  description: 'Automatically save content',

  install(api: EditorAPI, config?: { interval: number }) {
    const interval = config?.interval || 30000 // 30 seconds

    let timer: NodeJS.Timeout

    const startAutoSave = () => {
      timer = setInterval(() => {
        const content = api.state.getContent()
        // ä¿å­˜åˆ°å­˜å‚¨
        api.storage.set('auto-save', content)
      }, interval)
    }

    const stopAutoSave = () => {
      clearInterval(timer)
    }

    // ç¼–è¾‘å¼€å§‹æ—¶å¯åŠ¨è‡ªåŠ¨ä¿å­˜
    api.events.on('focus', startAutoSave)

    // ç¼–è¾‘ç»“æŸæ—¶åœæ­¢è‡ªåŠ¨ä¿å­˜
    api.events.on('blur', stopAutoSave)

    // åˆå§‹å¯åŠ¨
    startAutoSave()
  },

  uninstall(api: EditorAPI) {
    // æ¸…ç†å·¥ä½œ
  }
}
```

---

## é…ç½®ç³»ç»Ÿè®¾è®¡

### é…ç½®ç®¡ç†å™¨å®ç°

```typescript
// config/ConfigManager.ts
export class ConfigManager {
  private config: EditorConfig
  private defaults: EditorConfig
  private validators: Map<keyof EditorConfig, Validator<any>>
  private listeners: Set<ConfigListener>

  constructor(initialConfig?: Partial<EditorConfig>) {
    this.defaults = this.getDefaultConfig()
    this.config = { ...this.defaults, ...initialConfig }
    this.validators = new Map()
    this.listeners = new Set()

    this.setupValidators()
  }

  // è·å–é…ç½®å€¼
  get<K extends keyof EditorConfig>(key: K): EditorConfig[K] {
    return this.config[key]
  }

  // è®¾ç½®é…ç½®å€¼
  set<K extends keyof EditorConfig>(
    key: K,
    value: EditorConfig[K]
  ): void {
    const oldValue = this.config[key]
    const validator = this.validators.get(key)

    // éªŒè¯æ–°å€¼
    if (validator && !validator.validate(value)) {
      throw new Error(`Invalid value for config key "${key}"`)
    }

    // æ›´æ–°é…ç½®
    this.config[key] = value

    // é€šçŸ¥ç›‘å¬å™¨
    this.notifyListeners(key, value, oldValue)
  }

  // åˆå¹¶é…ç½®
  merge(config: Partial<EditorConfig>): void {
    for (const [key, value] of Object.entries(config)) {
      this.set(key as keyof EditorConfig, value as any)
    }
  }

  // é‡ç½®ä¸ºé»˜è®¤é…ç½®
  reset(): void {
    this.config = { ...this.defaults }
    this.notifyListeners('*', this.config, this.config)
  }

  // éªŒè¯é…ç½®
  validate(config: Partial<EditorConfig>): ValidationResult {
    const errors: string[] = []

    for (const [key, value] of Object.entries(config)) {
      const validator = this.validators.get(key as keyof EditorConfig)

      if (validator && !validator.validate(value)) {
        errors.push(
          `Invalid value for "${key}": ${validator.message}`
        )
      }
    }

    return {
      valid: errors.length === 0,
      errors
    }
  }

  // è®¢é˜…é…ç½®å˜åŒ–
  onChange(listener: ConfigListener): () => void {
    this.listeners.add(listener)
    return () => this.listeners.delete(listener)
  }

  // ç§æœ‰æ–¹æ³•ï¼šè·å–é»˜è®¤é…ç½®
  private getDefaultConfig(): EditorConfig {
    return {
      locale: 'en',
      readonly: false,
      spellcheck: true,
      content: {
        initialContent: '',
        placeholder: 'Type something...',
        sanitize: true,
        allowedTags: ['p', 'br', 'strong', 'em', 'u', 'a', 'img', 'table'],
        allowedAttributes: {
          'a': ['href', 'target'],
          'img': ['src', 'alt', 'width', 'height']
        }
      },
      toolbar: {
        position: 'top',
        rows: [
          {
            groups: [
              {
                id: 'history',
                items: [
                  { type: 'button', id: 'undo', command: 'undo' },
                  { type: 'button', id: 'redo', command: 'redo' }
                ],
                separator: true
              }
            ]
          }
        ],
        customButtons: []
      },
      shortcuts: [
        { key: 'Mod+z', command: 'undo' },
        { key: 'Mod+Shift+z', command: 'redo' },
        { key: 'Mod+b', command: 'bold' },
        { key: 'Mod+i', command: 'italic' },
        { key: 'Mod+u', command: 'underline' }
      ],
      image: {
        maxSize: 5 * 1024 * 1024, // 5MB
        maxWidth: 1200,
        maxHeight: 1200,
        defaultWidth: 300,
        defaultHeight: 200,
        resizeHandles: 'all'
      },
      table: {
        maxSize: { rows: 20, cols: 20 },
        defaultSize: { rows: 3, cols: 3 },
        resizeEnabled: true,
        mergeEnabled: true,
        splitEnabled: true
      },
      floatingImage: {
        enabled: true,
        defaultWidth: 240,
        defaultHeight: 160,
        minSize: 50,
        maxSize: 800
      },
      history: {
        maxSize: 100,
        debounceDelay: 1000
      },
      storage: {
        type: 'memory',
        options: {}
      },
      theme: {
        name: 'light',
        themes: []
      },
      plugins: []
    }
  }

  // ç§æœ‰æ–¹æ³•ï¼šè®¾ç½®éªŒè¯å™¨
  private setupValidators(): void {
    // Locale éªŒè¯å™¨
    this.validators.set('locale', {
      validate: (value) => /^[a-z]{2}(-[A-Z]{2})?$/.test(value),
      message: 'Locale must be in format "en" or "en-US"'
    })

    // å›¾ç‰‡å¤§å°éªŒè¯å™¨
    this.validators.set('image', {
      validate: (value) => {
        return (
          value.maxSize > 0 &&
          value.maxWidth > 0 &&
          value.maxHeight > 0
        )
      },
      message: 'Image size must be positive'
    })

    // è¡¨æ ¼å¤§å°éªŒè¯å™¨
    this.validators.set('table', {
      validate: (value) => {
        return (
          value.maxSize.rows > 0 &&
          value.maxSize.cols > 0 &&
          value.defaultSize.rows > 0 &&
          value.defaultSize.cols > 0
        )
      },
      message: 'Table size must be positive'
    })
  }

  // ç§æœ‰æ–¹æ³•ï¼šé€šçŸ¥ç›‘å¬å™¨
  private notifyListeners<K extends keyof EditorConfig>(
    key: K,
    newValue: EditorConfig[K],
    oldValue: EditorConfig[K]
  ): void {
    this.listeners.forEach(listener => {
      listener(key, newValue, oldValue)
    })
  }
}

// ç±»å‹å®šä¹‰
interface Validator<T> {
  validate(value: T): boolean
  message: string
}

interface ValidationResult {
  valid: boolean
  errors: string[]
}

type ConfigListener = <K extends keyof EditorConfig>(
  key: K,
  newValue: EditorConfig[K],
  oldValue: EditorConfig[K]
) => void
```

### å·¥å…·æ é…ç½®æ„å»ºå™¨

```typescript
// config/ToolbarBuilder.ts
export class ToolbarBuilder {
  private config: ToolbarConfig

  constructor() {
    this.config = {
      position: 'top',
      rows: [],
      customButtons: []
    }
  }

  // è®¾ç½®ä½ç½®
  setPosition(position: 'top' | 'bottom' | 'floating'): this {
    this.config.position = position
    return this
  }

  // æ·»åŠ è¡Œ
  addRow(): ToolbarRowBuilder {
    const rowBuilder = new ToolbarRowBuilder()
    this.config.rows.push(rowBuilder.build())
    return rowBuilder
  }

  // æ·»åŠ è‡ªå®šä¹‰æŒ‰é’®
  addCustomButton(button: CustomButton): this {
    this.config.customButtons.push(button)
    return this
  }

  // æ„å»ºé…ç½®
  build(): ToolbarConfig {
    return this.config
  }
}

export class ToolbarRowBuilder {
  private groups: ToolbarGroup[] = []

  // æ·»åŠ æŒ‰é’®ç»„
  addGroup(
    id: string,
    items: ToolbarItem[],
    separator = false
  ): this {
    this.groups.push({ id, items, separator })
    return this
  }

  // æ·»åŠ åˆ†éš”ç¬¦
  addSeparator(): this {
    return this
  }

  // æ„å»ºè¡Œé…ç½®
  build(): ToolbarRow {
    return { groups: this.groups }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const toolbarConfig = new ToolbarBuilder()
  .setPosition('top')
  .addRow()
    .addGroup('history', [
      { type: 'button', id: 'undo', command: 'undo' },
      { type: 'button', id: 'redo', command: 'redo' }
    ], true)
    .addGroup('format', [
      { type: 'button', id: 'bold', command: 'bold' },
      { type: 'button', id: 'italic', command: 'italic' },
      { type: 'button', id: 'underline', command: 'underline' }
    ], true)
  .build()
```

---

## ä¸»é¢˜ç³»ç»Ÿè®¾è®¡

### åŸºäº Tailwind CSS çš„ä¸»é¢˜ç³»ç»Ÿ

**è®¾è®¡åŸåˆ™ï¼š**
- åˆ©ç”¨ Tailwind çš„ `dark:` å‰ç¼€å®ç°æš—è‰²æ¨¡å¼
- ä½¿ç”¨ Tailwind Config è‡ªå®šä¹‰é¢œè‰²å’Œæ ·å¼
- é€šè¿‡ className ç»„åˆå®ç°ä¸»é¢˜åˆ‡æ¢

### ä¸»é¢˜é…ç½®

```typescript
// theme/ThemeConfig.ts
export interface ThemeConfig {
  name: string
  mode: 'light' | 'dark'
  colors: {
    primary: string
    secondary: string
    background: string
    surface: string
    border: string
    text: string
    textSecondary: string
  }
}

// é»˜è®¤ä¸»é¢˜é…ç½®
export const defaultThemes: Record<string, ThemeConfig> = {
  light: {
    name: 'light',
    mode: 'light',
    colors: {
      primary: '#3b82f6',
      secondary: '#6b7280',
      background: '#ffffff',
      surface: '#f9fafb',
      border: '#e5e7eb',
      text: '#111827',
      textSecondary: '#6b7280'
    }
  },
  dark: {
    name: 'dark',
    mode: 'dark',
    colors: {
      primary: '#60a5fa',
      secondary: '#9ca3af',
      background: '#111827',
      surface: '#1f2937',
      border: '#374151',
      text: '#f9fafb',
      textSecondary: '#9ca3af'
    }
  }
}
```

### ä¸»é¢˜ç®¡ç†å™¨

```typescript
// theme/ThemeManager.ts
export class ThemeManager {
  private currentTheme: ThemeConfig
  private themes: Record<string, ThemeConfig>
  private listeners: Set<(theme: ThemeConfig) => void>

  constructor(initialTheme: ThemeConfig, themes: Record<string, ThemeConfig>) {
    this.currentTheme = initialTheme
    this.themes = themes
    this.listeners = new Set()
  }

  // è®¾ç½®ä¸»é¢˜
  setTheme(themeName: string): void {
    const theme = this.themes[themeName]
    if (!theme) {
      throw new Error(`Theme not found: ${themeName}`)
    }

    this.currentTheme = theme
    this.applyTheme(theme)
    this.notifyListeners()
  }

  // è·å–å½“å‰ä¸»é¢˜
  getTheme(): ThemeConfig {
    return this.currentTheme
  }

  // åˆ‡æ¢æš—è‰²æ¨¡å¼
  toggleDarkMode(): void {
    const newMode = this.currentTheme.mode === 'light' ? 'dark' : 'light'
    const themeName = newMode === 'dark' ? 'dark' : 'light'
    this.setTheme(themeName)
  }

  // ç›‘å¬ä¸»é¢˜å˜åŒ–
  onChange(listener: (theme: ThemeConfig) => void): () => void {
    this.listeners.add(listener)
    return () => this.listeners.delete(listener)
  }

  // è·å– Tailwind className å‰ç¼€
  getThemeClass(): string {
    return this.currentTheme.mode === 'dark' ? 'dark' : ''
  }

  // ç§æœ‰æ–¹æ³•ï¼šåº”ç”¨ä¸»é¢˜
  private applyTheme(theme: ThemeConfig): void {
    const root = document.documentElement

    // è®¾ç½® dark ç±»
    if (theme.mode === 'dark') {
      root.classList.add('dark')
    } else {
      root.classList.remove('dark')
    }

    // è®¾ç½® data-theme å±æ€§
    root.setAttribute('data-theme', theme.name)
  }

  // ç§æœ‰æ–¹æ³•ï¼šé€šçŸ¥ç›‘å¬å™¨
  private notifyListeners(): void {
    this.listeners.forEach(listener => listener(this.currentTheme))
  }
}
```

### Tailwind é…ç½®

```javascript
// tailwind.config.js
module.exports = {
  darkMode: 'class', // æ‰‹åŠ¨æ§åˆ¶æš—è‰²æ¨¡å¼
  theme: {
    extend: {
      colors: {
        // ç¼–è¾‘å™¨ä¸»é¢˜é¢œè‰²
        primary: 'var(--editor-primary)',
        secondary: 'var(--editor-secondary)',
        background: 'var(--editor-background)',
        surface: 'var(--editor-surface)',
        border: 'var(--editor-border)',
        text: {
          DEFAULT: 'var(--editor-text)',
          secondary: 'var(--editor-text-secondary)'
        }
      }
    }
  }
}
```

### åœ¨ç»„ä»¶ä¸­ä½¿ç”¨

```tsx
// components/Editor.tsx
import { useTheme } from '../hooks/useTheme'

export const Editor: React.FC<EditorProps> = ({ config }) => {
  const { theme, toggleDarkMode } = useTheme()

  return (
    <div className={`${theme.getThemeClass()} bg-white dark:bg-background text-text dark:text-text`}>
      <Toolbar />
      <EditorArea />

      <button onClick={toggleDarkMode}>
        {theme.getTheme().mode === 'light' ? 'ğŸŒ™' : 'â˜€ï¸'}
      </button>
    </div>
  )
}
```

### ä¸»é¢˜ Hook

```typescript
// hooks/useTheme.ts
import { useContext } from 'react'
import { ThemeContext } from '../contexts/ThemeContext'

export function useTheme() {
  const context = useContext(ThemeContext)
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider')
  }
  return context
}
```

### ä¸»é¢˜ Provider

```tsx
// contexts/ThemeContext.tsx
import { createContext, ReactNode } from 'react'
import { ThemeManager, defaultThemes } from '../theme/ThemeConfig'

interface ThemeContextValue {
  theme: ThemeManager
  toggleDarkMode: () => void
}

export const ThemeContext = createContext<ThemeContextValue | null>(null)

export const ThemeProvider: React.FC<{
  children: ReactNode
  initialTheme?: string
}> = ({ children, initialTheme = 'light' }) => {
  const themeManager = new ThemeManager(
    defaultThemes[initialTheme],
    defaultThemes
  )

  return (
    <ThemeContext.Provider
      value={{
        theme: themeManager,
        toggleDarkMode: () => themeManager.toggleDarkMode()
      }}
    >
      {children}
    </ThemeContext.Provider>
  )
}
```
  private registerDefaultThemes(): void {
    // Light Theme
    this.registerTheme({
      name: 'light',
      colors: {
        primary: '#3b82f6',
        secondary: '#6b7280',
        background: '#ffffff',
        surface: '#f9fafb',
        border: '#e5e7eb',
        text: '#111827',
        textSecondary: '#6b7280',
        error: '#ef4444',
        warning: '#f59e0b',
        success: '#10b981',
        info: '#3b82f6'
      },
      typography: {
        fontFamily: 'Inter, system-ui, sans-serif',
        fontSize: {
          xs: '0.75rem',
          sm: '0.875rem',
          md: '1rem',
          lg: '1.125rem',
          xl: '1.25rem'
        },
        fontWeight: {
          normal: 400,
          medium: 500,
          semibold: 600,
          bold: 700
        },
        lineHeight: {
          tight: 1.25,
          normal: 1.5,
          relaxed: 1.75
        }
      },
      spacing: {
        xs: '0.25rem',
        sm: '0.5rem',
        md: '1rem',
        lg: '1.5rem',
        xl: '2rem'
      },
      borderRadius: {
        sm: '0.25rem',
        md: '0.5rem',
        lg: '0.75rem',
        full: '9999px'
      },
      shadows: {
        sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
        md: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
        lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
        xl: '0 20px 25px -5px rgba(0, 0, 0, 0.1)'
      },
      transitions: {
        fast: '150ms',
        normal: '200ms',
        slow: '300ms'
      },
      components: {
        toolbar: {
          background: '#ffffff',
          border: '#e5e7eb',
          padding: '0.75rem',
          gap: '0.5rem',
          height: '3rem'
        },
        button: {
          primary: {
            background: '#3b82f6',
            color: '#ffffff',
            hoverBackground: '#2563eb',
            activeBackground: '#1d4ed8',
            disabledBackground: '#e5e7eb',
            disabledColor: '#9ca3af'
          },
          secondary: {
            background: '#f3f4f6',
            color: '#374151',
            hoverBackground: '#e5e7eb',
            activeBackground: '#d1d5db',
            disabledBackground: '#f9fafb',
            disabledColor: '#9ca3af'
          },
          ghost: {
            background: 'transparent',
            color: '#374151',
            hoverBackground: '#f3f4f6',
            activeBackground: '#e5e7eb',
            disabledBackground: 'transparent',
            disabledColor: '#9ca3af'
          }
        }
      }
    })

    // Dark Theme
    this.registerTheme({
      name: 'dark',
      colors: {
        primary: '#60a5fa',
        secondary: '#9ca3af',
        background: '#111827',
        surface: '#1f2937',
        border: '#374151',
        text: '#f9fafb',
        textSecondary: '#9ca3af',
        error: '#f87171',
        warning: '#fbbf24',
        success: '#34d399',
        info: '#60a5fa'
      },
      typography: {
        fontFamily: 'Inter, system-ui, sans-serif',
        fontSize: {
          xs: '0.75rem',
          sm: '0.875rem',
          md: '1rem',
          lg: '1.125rem',
          xl: '1.25rem'
        },
        fontWeight: {
          normal: 400,
          medium: 500,
          semibold: 600,
          bold: 700
        },
        lineHeight: {
          tight: 1.25,
          normal: 1.5,
          relaxed: 1.75
        }
      },
      spacing: {
        xs: '0.25rem',
        sm: '0.5rem',
        md: '1rem',
        lg: '1.5rem',
        xl: '2rem'
      },
      borderRadius: {
        sm: '0.25rem',
        md: '0.5rem',
        lg: '0.75rem',
        full: '9999px'
      },
      shadows: {
        sm: '0 1px 2px 0 rgba(0, 0, 0, 0.3)',
        md: '0 4px 6px -1px rgba(0, 0, 0, 0.4)',
        lg: '0 10px 15px -3px rgba(0, 0, 0, 0.4)',
        xl: '0 20px 25px -5px rgba(0, 0, 0, 0.5)'
      },
      transitions: {
        fast: '150ms',
        normal: '200ms',
        slow: '300ms'
      },
      components: {
        toolbar: {
          background: '#1f2937',
          border: '#374151',
          padding: '0.75rem',
          gap: '0.5rem',
          height: '3rem'
        },
        button: {
          primary: {
            background: '#3b82f6',
            color: '#ffffff',
            hoverBackground: '#2563eb',
            activeBackground: '#1d4ed8',
            disabledBackground: '#374151',
            disabledColor: '#6b7280'
          },
          secondary: {
            background: '#374151',
            color: '#e5e7eb',
            hoverBackground: '#4b5563',
            activeBackground: '#6b7280',
            disabledBackground: '#1f2937',
            disabledColor: '#6b7280'
          },
          ghost: {
            background: 'transparent',
            color: '#e5e7eb',
            hoverBackground: '#374151',
            activeBackground: '#4b5563',
            disabledBackground: 'transparent',
            disabledColor: '#6b7280'
          }
        }
      }
    })
  }

  // ç§æœ‰æ–¹æ³•ï¼šé€šçŸ¥ç›‘å¬å™¨
  private notifyListeners(): void {
    this.listeners.forEach(listener => {
      listener(this.currentTheme)
    })
  }
}
```

---

## ç»„ä»¶é‡æ„æ–¹æ¡ˆ

### ç»„ä»¶æ¥å£è®¾è®¡

```typescript
// components/Editor.tsx
import React, { useRef, useState } from 'react'
import { createPortal } from 'react-dom'

export interface EditorProps {
  // å†…å®¹
  content: string
  onContentChange: (content: string) => void

  // é…ç½®
  config?: Partial<EditorConfig>

  // ä¸»é¢˜
  theme?: Theme

  // æ’ä»¶
  plugins?: Plugin[]

  // çŠ¶æ€
  readonly?: boolean
  disabled?: boolean

  // å›è°ƒ
  onFocus?: () => void
  onBlur?: () => void
  onReady?: () => void

  // æ ·å¼
  className?: string
  style?: React.CSSProperties

  // Ref
  editorRef?: RefObject<EditorRef>
}

export interface EditorRef {
  // å‘½ä»¤æ‰§è¡Œ
  executeCommand(command: string, ...args: any[]): void

  // å†…å®¹æ“ä½œ
  getContent(): string
  setContent(content: string): void

  // é€‰æ‹©æ“ä½œ
  getSelection(): Selection | null
  setSelection(selection: Selection): void

  // çŠ¶æ€æŸ¥è¯¢
  getState(): EditorState

  // ç„¦ç‚¹æ§åˆ¶
  focus(): void
  blur(): void
}

export const Editor: React.FC<EditorProps> = ({
  content,
  onContentChange,
  config: userConfig = {},
  theme: userTheme,
  plugins = [],
  readonly = false,
  disabled = false,
  onFocus,
  onBlur,
  onReady,
  className,
  style,
  editorRef
}) => {
  // åˆå§‹åŒ–æ ¸å¿ƒæ¨¡å—
  const configManager = useRef(new ConfigManager(userConfig))
  const themeManager = useRef(new ThemeManager(userTheme || defaultTheme))
  const commandManager = useRef(new CommandManager())
  const stateManager = useRef(new StateManager())
  const historyManager = useRef(new HistoryManager())
  const eventBus = useRef(new EventBus())
  const pluginManager = useRef(new PluginManager(createEditorAPI()))

  const [isReady, setIsReady] = useState(false)
  const iframeRef = useRef<HTMLIFrameElement>(null)

  // åˆ›å»º Editor API
  function createEditorAPI(): EditorAPI {
    return {
      commands: commandManager.current,
      state: stateManager.current,
      history: historyManager.current,
      events: eventBus.current,
      config: configManager.current,
      theme: themeManager.current
    }
  }

  // åˆå§‹åŒ–
  useEffect(() => {
    const init = async () => {
      // åŠ è½½æ’ä»¶
      for (const plugin of plugins) {
        await pluginManager.current.register(plugin)
      }

      setIsReady(true)
      onReady?.()
    }

    init()
  }, [plugins])

  // å†…å®¹å˜åŒ–å¤„ç†
  useEffect(() => {
    if (isReady) {
      stateManager.current.setState({ content })
    }
  }, [content, isReady])

  // æš´éœ² ref æ–¹æ³•
  useImperativeHandle(editorRef, () => ({
    executeCommand: (command, ...args) => {
      commandManager.current.execute(command, ...args)
    },
    getContent: () => {
      return stateManager.current.getState().content
    },
    setContent: (newContent) => {
      stateManager.current.setState({ content: newContent })
      onContentChange(newContent)
    },
    getSelection: () => {
      return stateManager.current.getState().selection
    },
    setSelection: (selection) => {
      stateManager.current.setState({ selection })
    },
    getState: () => {
      return stateManager.current.getState()
    },
    focus: () => {
      iframeRef.current?.focus()
    },
    blur: () => {
      iframeRef.current?.blur()
    }
  }), [isReady])

  // è·å– CSS å˜é‡
  const cssVars = themeManager.current.getCSSVariables()

  return (
    <div
      className={`editor-container ${className || ''}`}
      style={{ ...cssVars, ...style }}
      data-readonly={readonly}
      data-disabled={disabled}
    >
      {isReady && (
        <>
          <Toolbar
            api={createEditorAPI()}
            config={configManager.current.get('toolbar')}
          />
          <EditorArea
            ref={iframeRef}
            content={content}
            onContentChange={onContentChange}
            config={configManager.current}
            api={createEditorAPI()}
            onFocus={onFocus}
            onBlur={onBlur}
          />
        </>
      )}
    </div>
  )
}
```

### å·¥å…·æ ç»„ä»¶é‡æ„

```typescript
// components/Toolbar.tsx
interface ToolbarProps {
  api: EditorAPI
  config: ToolbarConfig
}

export const Toolbar: React.FC<ToolbarProps> = ({ api, config }) => {
  const [state, setState] = useState<EditorState>(api.state.getState())

  // è®¢é˜…çŠ¶æ€å˜åŒ–
  useEffect(() => {
    const unsubscribe = api.state.subscribe((newState) => {
      setState(newState)
    })
    return unsubscribe
  }, [api])

  if (config.position === 'floating') {
    return createPortal(
      <FloatingToolbar api={api} config={config} state={state} />,
      document.body
    )
  }

  return (
    <div
      className={`toolbar toolbar-${config.position}`}
      role="toolbar"
      aria-label="Editor toolbar"
    >
      {config.rows.map((row, rowIndex) => (
        <div key={rowIndex} className="toolbar-row">
          {row.groups.map((group) => (
            <ToolbarGroup
              key={group.id}
              group={group}
              api={api}
              state={state}
            />
          ))}
        </div>
      ))}
    </div>
  )
}

// å·¥å…·æ ç»„
interface ToolbarGroupProps {
  group: ToolbarGroup
  api: EditorAPI
  state: EditorState
}

const ToolbarGroup: React.FC<ToolbarGroupProps> = ({ group, api, state }) => {
  return (
    <div className="toolbar-group">
      {group.items.map((item) => (
        <ToolbarItem
          key={item.id}
          item={item}
          api={api}
          state={state}
        />
      ))}
      {group.separator && <div className="toolbar-separator" />}
    </div>
  )
}

// å·¥å…·æ é¡¹
interface ToolbarItemProps {
  item: ToolbarItem
  api: EditorAPI
  state: EditorState
}

const ToolbarItem: React.FC<ToolbarItemProps> = ({ item, api, state }) => {
  switch (item.type) {
    case 'button':
      return <ToolbarButton item={item} api={api} state={state} />
    case 'select':
      return <ToolbarSelect item={item} api={api} state={state} />
    case 'colorPicker':
      return <ColorPicker item={item} api={api} state={state} />
    default:
      return null
  }
}

// å·¥å…·æ æŒ‰é’®
const ToolbarButton: React.FC<{
  item: ToolbarButton
  api: EditorAPI
  state: EditorState
}> = ({ item, api, state }) => {
  const isActive = item.active ? item.active(state) : false
  const isDisabled = item.disabled ?? false

  const handleClick = () => {
    api.commands.execute(item.command, ...(item.commandArgs || []))
  }

  return (
    <button
      className={`toolbar-button ${isActive ? 'active' : ''}`}
      disabled={isDisabled}
      onClick={handleClick}
      title={item.tooltip}
      aria-label={item.tooltip}
      aria-pressed={isActive}
    >
      {typeof item.icon === 'string' ? (
        <span className="icon">{item.icon}</span>
      ) : (
        <item.icon />
      )}
    </button>
  )
}
```

---

## åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### é˜¶æ®µæ¦‚è§ˆ

| é˜¶æ®µ | åç§° | æ—¶é—´ | é£é™© | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| 1 | æ ¸å¿ƒæ¶æ„æŠ½è±¡ | 15h | ä½ | P0 |
| 2 | æ’ä»¶ç³»ç»Ÿå®ç° | 25h | é«˜ | P0 |
| 3 | é…ç½®ä¸ä¸»é¢˜ç³»ç»Ÿ | 20h | ä½ | P0 |
| 4 | ç»„ä»¶é‡æ„ä¸ä¼˜åŒ– | 20h | ä¸­ | P0 |
| 5 | æµ‹è¯•ä¸æ–‡æ¡£ | 10h | ä½ | P1 |
| **æ€»è®¡** | - | **90h** | - | - |

### é˜¶æ®µ 1ï¼šæ ¸å¿ƒæ¶æ„æŠ½è±¡ï¼ˆ15å°æ—¶ï¼‰

#### ç›®æ ‡
- å®ç°æ ¸å¿ƒæ¨¡å—æ¥å£ï¼ˆå‘½ä»¤ç®¡ç†ã€çŠ¶æ€ç®¡ç†ã€å†å²ç®¡ç†ï¼‰
- å»ºç«‹æ¨¡å—åŒ–ä»£ç ç»“æ„
- å®Œæˆæ ¸å¿ƒåŠŸèƒ½æŠ½è±¡

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 1.1ï¼šå®ç° CommandManagerï¼ˆ4hï¼‰**
```typescript
// core/command/CommandManager.ts
export class CommandManager {
  private commands = new Map<string, CommandHandler>()

  execute(name: string, ...args: any[]): void {
    const handler = this.commands.get(name)
    if (!handler) {
      throw new Error(`Command not found: ${name}`)
    }
    handler(...args)
  }

  register(name: string, handler: CommandHandler): void {
    this.commands.set(name, handler)
  }

  unregister(name: string): void {
    this.commands.delete(name)
  }

  has(name: string): boolean {
    return this.commands.has(name)
  }
}
```

**ä»»åŠ¡ 1.2ï¼šå®ç° StateManagerï¼ˆ4hï¼‰**
```typescript
// editor-core/src/state/StateManager.ts
export class StateManager {
  private state: EditorState
  private listeners = new Set<StateListener>()

  constructor(initialState: EditorState) {
    this.state = initialState
  }

  getState(): EditorState {
    return this.state
  }

  setState(updater: StateUpdater): void {
    const newState = typeof updater === 'function'
      ? updater(this.state)
      : updater

    const oldState = this.state
    this.state = newState

    this.listeners.forEach(listener => {
      listener(newState, oldState)
    })
  }

  subscribe(listener: StateListener): () => void {
    this.listeners.add(listener)
    return () => this.listeners.delete(listener)
  }
}
```

**ä»»åŠ¡ 1.3ï¼šå®ç° HistoryManagerï¼ˆ4hï¼‰**
```typescript
// editor-core/src/history/HistoryManager.ts
export class HistoryManager {
  private past: EditorState[] = []
  private future: EditorState[] = []
  private maxSize: number

  constructor(maxSize = 100) {
    this.maxSize = maxSize
  }

  push(state: EditorState): void {
    this.past.push(state)
    if (this.past.length > this.maxSize) {
      this.past.shift()
    }
    this.future = []
  }

  undo(): EditorState | null {
    if (this.past.length === 0) return null

    const current = this.past.pop()!
    this.future.push(current)

    return this.past[this.past.length - 1] ?? null
  }

  redo(): EditorState | null {
    if (this.future.length === 0) return null

    const state = this.future.pop()!
    this.past.push(state)

    return state
  }

  canUndo(): boolean {
    return this.past.length > 1
  }

  canRedo(): boolean {
    return this.future.length > 0
  }

  clear(): void {
    this.past = []
    this.future = []
  }
}
```

**ä»»åŠ¡ 1.4ï¼šè¿ç§»æ ¸å¿ƒå‘½ä»¤ï¼ˆ3hï¼‰**

å°†ç°æœ‰çš„ `useEditorCommands.ts` ä¸­çš„å‘½ä»¤è¿ç§»åˆ° CommandManagerï¼š

```typescript
// core/command/commands/index.ts
import { CommandManager } from '../CommandManager'

export function registerBuiltinCommands(manager: CommandManager) {
  // æ–‡æœ¬æ ¼å¼åŒ–
  manager.register('bold', (doc) => doc.execCommand('bold'))
  manager.register('italic', (doc) => doc.execCommand('italic'))
  manager.register('underline', (doc) => doc.execCommand('underline'))
  manager.register('strikeThrough', (doc) => doc.execCommand('strikeThrough'))

  // æ®µè½æ ¼å¼
  manager.register('formatBlock', (doc, tag) => doc.execCommand('formatBlock', false, tag))
  manager.register('justifyLeft', (doc) => doc.execCommand('justifyLeft'))
  manager.register('justifyCenter', (doc) => doc.execCommand('justifyCenter'))
  manager.register('justifyRight', (doc) => doc.execCommand('justifyRight'))

  // æ’å…¥å‘½ä»¤
  manager.register('insertImage', (doc, src) => {
    const img = doc.createElement('img')
    img.src = src
    insertNodeAtSelection(doc, img)
  })

  // ... å…¶ä»–å‘½ä»¤
}
```

#### æµ‹è¯•éªŒè¯
```typescript
// __tests__/core/CommandManager.test.ts
describe('CommandManager', () => {
  it('should register and execute commands', () => {
    const manager = new CommandManager()
    const mock = jest.fn()

    manager.register('test', mock)
    manager.execute('test', 'arg1', 'arg2')

    expect(mock).toHaveBeenCalledWith('arg1', 'arg2')
  })

  it('should throw error for unknown command', () => {
    const manager = new CommandManager()

    expect(() => manager.execute('unknown'))
      .toThrow('Command not found: unknown')
  })
})
```

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šæ¥å£è®¾è®¡ä¸å®Œå–„
- **åº”å¯¹**ï¼šå‚è€ƒç°æœ‰ä»£ç ï¼Œé¢„ç•™æ‰©å±•ç©ºé—´
- **éªŒè¯**ï¼šæ¯ä¸ªæ¨¡å—éƒ½æœ‰å•å…ƒæµ‹è¯•

---

### é˜¶æ®µ 2ï¼šæ’ä»¶ç³»ç»Ÿå®ç°ï¼ˆ25å°æ—¶ï¼‰

#### ç›®æ ‡
- å®ç°å®Œæ•´çš„æ’ä»¶ç³»ç»Ÿ
- æä¾›æ’ä»¶ API å’Œç”Ÿå‘½å‘¨æœŸé’©å­
- å®ç°äº‹ä»¶ç³»ç»Ÿ

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 2.1ï¼šå®ç°æ’ä»¶ç®¡ç†å™¨ï¼ˆ8hï¼‰**

```typescript
// plugin/PluginManager.ts
export class PluginManager {
  private plugins = new Map<string, PluginInstance>()
  private api: EditorAPI

  constructor(api: EditorAPI) {
    this.api = api
  }

  async register<TConfig>(plugin: Plugin<TConfig>, config?: TConfig) {
    // æ£€æŸ¥ä¾èµ–
    await this.checkDependencies(plugin)

    // åˆ›å»ºå®ä¾‹
    const instance: PluginInstance = {
      plugin,
      config,
      state: 'registered'
    }

    // å®‰è£…
    await plugin.install(this.api, config)

    // æ³¨å†Œæ‰©å±•
    await this.registerExtensions(plugin)

    this.plugins.set(plugin.name, instance)
  }

  async unregister(name: string) {
    // å®ç°æ³¨é”€é€»è¾‘
  }

  async activate(name: string) {
    // å®ç°æ¿€æ´»é€»è¾‘
  }

  async deactivate(name: string) {
    // å®ç°åœç”¨é€»è¾‘
  }
}
```

**ä»»åŠ¡ 2.2ï¼šå®ç°äº‹ä»¶ç³»ç»Ÿï¼ˆ7hï¼‰**

```typescript
// plugin/EventBus.ts
export class EventBus {
  private listeners = new Map<string, Set<EventHandler>>()

  on(event: string, handler: EventHandler): () => void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set())
    }
    this.listeners.get(event)!.add(handler)

    return () => this.off(event, handler)
  }

  emit(event: string, ...args: any[]): void {
    this.listeners.get(event)?.forEach(handler => {
      handler(...args)
    })
  }

  off(event: string, handler: EventHandler): void {
    this.listeners.get(event)?.delete(handler)
  }
}
```

**ä»»åŠ¡ 2.3ï¼šå®ç°ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆ6hï¼‰**

```typescript
// plugin/HookRegistry.ts
export class HookRegistry {
  private hooks: Record<string, Hook[]> = {}

  register(name: string, hook: Hook): void {
    if (!this.hooks[name]) {
      this.hooks[name] = []
    }
    this.hooks[name].push(hook)
  }

  async execute(name: string, context: any): Promise<any> {
    const hooks = this.hooks[name] || []
    let result = context

    for (const hook of hooks) {
      result = await hook(result)
    }

    return result
  }
}
```

**ä»»åŠ¡ 2.4ï¼šåˆ›å»ºç¤ºä¾‹æ’ä»¶ï¼ˆ4hï¼‰**

- å­—æ•°ç»Ÿè®¡æ’ä»¶
- è‡ªåŠ¨ä¿å­˜æ’ä»¶
- å¿«æ·é”®æç¤ºæ’ä»¶

#### æµ‹è¯•éªŒè¯
- æµ‹è¯•æ’ä»¶æ³¨å†Œ/æ³¨é”€
- æµ‹è¯•äº‹ä»¶ç³»ç»Ÿ
- æµ‹è¯•ç”Ÿå‘½å‘¨æœŸé’©å­

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šæ’ä»¶ç³»ç»Ÿå¤æ‚åº¦é«˜
- **åº”å¯¹**ï¼š
  - åˆ†æ­¥å®ç°ï¼Œé€æ­¥æµ‹è¯•
  - æä¾›è¯¦ç»†ç¤ºä¾‹å’Œæ–‡æ¡£
- **éªŒè¯**ï¼šç¤ºä¾‹æ’ä»¶æ­£å¸¸è¿è¡Œ

---

### é˜¶æ®µ 3ï¼šé…ç½®ä¸ä¸»é¢˜ç³»ç»Ÿï¼ˆ20å°æ—¶ï¼‰

#### ç›®æ ‡
- å®ç°é…ç½®ç®¡ç†å™¨
- å®ç°åŸºäº Tailwind çš„ä¸»é¢˜ç³»ç»Ÿ
- æ”¯æŒè¿è¡Œæ—¶é…ç½®æ›´æ–°

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 3.1ï¼šå®ç°é…ç½®ç®¡ç†å™¨ï¼ˆ8hï¼‰**

**ä»»åŠ¡ 3.2ï¼šå®ç°ä¸»é¢˜ç®¡ç†å™¨ï¼ˆ7hï¼‰**

**ä»»åŠ¡ 3.3ï¼šå·¥å…·æ é…ç½®ç³»ç»Ÿï¼ˆ5hï¼‰**

#### æµ‹è¯•éªŒè¯

#### é£é™©æ§åˆ¶

---

### é˜¶æ®µ 4ï¼šç»„ä»¶é‡æ„ä¸ä¼˜åŒ–ï¼ˆ20å°æ—¶ï¼‰

#### ç›®æ ‡
- é‡æ„ç°æœ‰ç»„ä»¶ï¼Œä½¿ç”¨æ–°çš„æ ¸å¿ƒæ¶æ„
- æå‡ç»„ä»¶å¤ç”¨æ€§
- ä¼˜åŒ–æ€§èƒ½

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 4.1ï¼šé‡æ„ EditablePreview ç»„ä»¶ï¼ˆ8hï¼‰**

- ä½¿ç”¨æ–°çš„ CommandManager æ›¿ä»£ useEditorCommands
- ä½¿ç”¨ StateManager ç»Ÿä¸€ç®¡ç†çŠ¶æ€
- ä½¿ç”¨ HistoryManager ç®¡ç†å†å²

**ä»»åŠ¡ 4.2ï¼šé‡æ„ EditorToolbar ç»„ä»¶ï¼ˆ6hï¼‰**

- ä½¿ç”¨é…ç½®ç³»ç»Ÿé©±åŠ¨å·¥å…·æ 
- æ”¯æŒåŠ¨æ€æŒ‰é’®æ˜¾ç¤º/éšè—
- æ”¯æŒè‡ªå®šä¹‰æŒ‰é’®

**ä»»åŠ¡ 4.3ï¼šä¼˜åŒ– FloatingImageLayer ç»„ä»¶ï¼ˆ3hï¼‰**

**ä»»åŠ¡ 4.4ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆ3hï¼‰**

- å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“
- ä¼˜åŒ–äº‹ä»¶å¤„ç†
- æ‡’åŠ è½½ç»„ä»¶

#### æµ‹è¯•éªŒè¯
- è¿è¡Œç°æœ‰ 209 ä¸ªæµ‹è¯•ç”¨ä¾‹
- ç¡®ä¿å…¨éƒ¨é€šè¿‡
- æ€§èƒ½å¯¹æ¯”æµ‹è¯•

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šé‡æ„å¼•å…¥ bug
- **åº”å¯¹**ï¼š
  - åˆ†æ­¥é‡æ„ï¼Œæ¯æ­¥éƒ½æµ‹è¯•
  - ä¿ç•™åŸä»£ç ä½œä¸ºå‚è€ƒ
- **éªŒè¯**ï¼šæ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### é˜¶æ®µ 5ï¼šæµ‹è¯•ä¸æ–‡æ¡£ï¼ˆ10å°æ—¶ï¼‰

#### ç›®æ ‡
- å®Œå–„æµ‹è¯•è¦†ç›–
- ç¼–å†™ä½¿ç”¨æ–‡æ¡£
- æä¾›ç¤ºä¾‹

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 5.1ï¼šå®Œå–„æµ‹è¯•ï¼ˆ5hï¼‰**

- è¡¥å……å•å…ƒæµ‹è¯•
- æ·»åŠ é›†æˆæµ‹è¯•
- æµ‹è¯•è¦†ç›–ç‡ > 80%

**ä»»åŠ¡ 5.2ï¼šç¼–å†™æ–‡æ¡£ï¼ˆ3hï¼‰**

- API æ–‡æ¡£
- é…ç½®è¯´æ˜
- æ’ä»¶å¼€å‘æŒ‡å—

**ä»»åŠ¡ 5.3ï¼šæä¾›ç¤ºä¾‹ï¼ˆ2hï¼‰**

- åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
- è‡ªå®šä¹‰é…ç½®ç¤ºä¾‹
- æ’ä»¶å¼€å‘ç¤ºä¾‹

#### æµ‹è¯•éªŒè¯
- è¿è¡Œæ‰€æœ‰æµ‹è¯•
- æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
- éªŒè¯ç¤ºä¾‹å¯è¿è¡Œ

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šæ–‡æ¡£ä¸å®Œå–„
- **åº”å¯¹**ï¼š
  - æä¾›è¯¦ç»†æ³¨é‡Š
  - å¤šä¸ªç¤ºä¾‹
- **éªŒè¯**ï¼šç”¨æˆ·èƒ½æ ¹æ®æ–‡æ¡£ç‹¬ç«‹ä½¿ç”¨

---
    }

    // å®‰è£…
    await plugin.install(this.api, config)

    // æ³¨å†Œæ‰©å±•
    await this.registerExtensions(plugin)

    this.plugins.set(plugin.name, instance)
  }

  async unregister(name: string) {
    // å®ç°æ³¨é”€é€»è¾‘
  }

  async activate(name: string) {
    // å®ç°æ¿€æ´»é€»è¾‘
  }

  async deactivate(name: string) {
    // å®ç°åœç”¨é€»è¾‘
  }
}
```

**ä»»åŠ¡ 3.2ï¼šå®ç°äº‹ä»¶ç³»ç»Ÿï¼ˆ7hï¼‰**

```typescript
// editor-core/src/event/EventBus.ts
export class EventBus {
  private listeners = new Map<string, Set<EventHandler>>()

  on(event: string, handler: EventHandler): () => void {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, new Set())
    }
    this.listeners.get(event)!.add(handler)

    return () => this.off(event, handler)
  }

  once(event: string, handler: EventHandler): () => void {
    const wrappedHandler = (...args: any[]) => {
      handler(...args)
      this.off(event, wrappedHandler)
    }
    return this.on(event, wrappedHandler)
  }

  off(event: string, handler: EventHandler): void {
    this.listeners.get(event)?.delete(handler)
  }

  emit(event: string, ...args: any[]): void {
    this.listeners.get(event)?.forEach(handler => {
      handler(...args)
    })
  }

  emitBatch(events: Array<{event: string, args: any[]}>): void {
    events.forEach(({event, args}) => {
      this.emit(event, ...args)
    })
  }
}
```

**ä»»åŠ¡ 3.3ï¼šå®ç°ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆ8hï¼‰**

```typescript
// editor-core/src/hook/HookRegistry.ts
export class HookRegistry {
  private hooks: Record<string, Hook[]> = {}

  register(name: string, hook: Hook): void {
    if (!this.hooks[name]) {
      this.hooks[name] = []
    }
    this.hooks[name].push(hook)
  }

  async execute(name: string, context: any): Promise<any> {
    const hooks = this.hooks[name] || []
    let result = context

    for (const hook of hooks) {
      result = await hook(result)
    }

    return result
  }
}

// å†…ç½®é’©å­
export const builtinHooks = {
  beforeContentChange: new AsyncWaterfallHook(),
  afterContentChange: new AsyncSeriesHook(),
  beforeCommand: new AsyncWaterfallHook(),
  afterCommand: new AsyncSeriesHook(),
  beforePluginLoad: new AsyncWaterfallHook(),
  afterPluginLoad: new AsyncSeriesHook()
}
```

#### ç¤ºä¾‹æ’ä»¶

**è¡¨æ ¼æ’ä»¶ï¼ˆä»ç°æœ‰ä»£ç è¿ç§»ï¼‰ï¼š**
```typescript
// plugins/table-plugin/src/index.ts
export const TablePlugin: Plugin = {
  name: 'table',
  version: '1.0.0',
  description: 'Table editing support',

  install(api) {
    // æ³¨å†Œè¡¨æ ¼å‘½ä»¤
    api.commands.register('insertTable', (doc, rows, cols) => {
      const html = createTableHTML(rows, cols)
      doc.execCommand('insertHTML', false, html)
    })

    // æ·»åŠ å·¥å…·æ æŒ‰é’®
    api.toolbar.addButton({
      id: 'insert-table',
      icon: TableIcon,
      tooltip: 'Insert Table',
      command: 'insertTable'
    })

    // ç›‘å¬è¡¨æ ¼é€‰æ‹©
    api.events.on('selection-change', (selection) => {
      const table = findTable(selection)
      if (table) {
        api.events.emit('table-activate', table)
      }
    })
  }
}
```

#### æµ‹è¯•éªŒè¯
```typescript
// __tests__/plugin/PluginManager.test.ts
describe('PluginManager', () => {
  it('should register and activate plugin', async () => {
    const api = createMockEditorAPI()
    const manager = new PluginManager(api)

    const plugin: Plugin = {
      name: 'test',
      version: '1.0.0',
      install: jest.fn()
    }

    await manager.register(plugin)
    expect(plugin.install).toHaveBeenCalledWith(api)

    expect(manager.hasPlugin('test')).toBe(true)
  })

  it('should check dependencies', async () => {
    const api = createMockEditorAPI()
    const manager = new PluginManager(api)

    const pluginWithDep: Plugin = {
      name: 'test',
      version: '1.0.0',
      dependencies: ['missing-plugin'],
      install: jest.fn()
    }

    await expect(manager.register(pluginWithDep))
      .rejects.toThrow('requires plugin "missing-plugin"')
  })
})
```

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šæ’ä»¶å†²çª
- **åº”å¯¹**ï¼š
  - å®ç°ä¾èµ–æ£€æŸ¥
  - æä¾›å†²çªæ£€æµ‹
  - æ’ä»¶éš”ç¦»
- **éªŒè¯**ï¼šé›†æˆæµ‹è¯•

---

### é˜¶æ®µ 4ï¼šé…ç½®ä¸ä¸»é¢˜ç³»ç»Ÿï¼ˆ20å°æ—¶ï¼‰

#### ç›®æ ‡
- å®ç°é…ç½®ç®¡ç†å™¨
- å®ç°ä¸»é¢˜ç®¡ç†å™¨
- æä¾›é¢„è®¾é…ç½®å’Œä¸»é¢˜

#### å…·ä½“ä»»åŠ¡

**ä»»åŠ¡ 4.1ï¼šå®ç°é…ç½®ç®¡ç†å™¨ï¼ˆ8hï¼‰**

è§å‰æ–‡é…ç½®ç³»ç»Ÿè®¾è®¡

**ä»»åŠ¡ 4.2ï¼šå®ç°ä¸»é¢˜ç®¡ç†å™¨ï¼ˆ8hï¼‰**

è§å‰æ–‡ä¸»é¢˜ç³»ç»Ÿè®¾è®¡

**ä»»åŠ¡ 4.3ï¼šæä¾›é¢„è®¾ï¼ˆ4hï¼‰**

```typescript
// presets/index.ts
export const presets = {
  minimal: {
    toolbar: {
      rows: [
        {
          groups: [
            { id: 'basic', items: ['bold', 'italic', 'underline'] }
          ]
        }
      ]
    }
  },

  full: {
    toolbar: {
      rows: [
        {
          groups: [
            { id: 'history', items: ['undo', 'redo'] },
            { id: 'format', items: ['bold', 'italic', 'underline', 'strike'] }
          ]
        }
      ]
    }
  }
}

export const themes = {
  light: lightTheme,
  dark: darkTheme,
  highContrast: highContrastTheme
}
```

#### æµ‹è¯•éªŒè¯
```typescript
// __tests__/config/ConfigManager.test.ts
describe('ConfigManager', () => {
  it('should get and set config values', () => {
    const manager = new ConfigManager()

    expect(manager.get('locale')).toBe('en')

    manager.set('locale', 'zh-CN')
    expect(manager.get('locale')).toBe('zh-CN')
  })

  it('should validate config values', () => {
    const manager = new ConfigManager()

    expect(() => manager.set('locale', 'invalid'))
      .toThrow('Invalid value')
  })
})
```

#### é£é™©æ§åˆ¶
- **é£é™©**ï¼šé…ç½®å†²çª
- **åº”å¯¹**ï¼šéªŒè¯å™¨ + åˆå¹¶ç­–ç•¥
- **éªŒè¯**ï¼šå•å…ƒæµ‹è¯•

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \        E2E Tests (5%)
      /----\
     /      \      Integration Tests (15%)
    /--------\
   /          \    Unit Tests (80%)
  /------------\
```

### å•å…ƒæµ‹è¯•

**ç›®æ ‡è¦†ç›–ç‡ï¼š**
- Core æ¨¡å—ï¼š>90%
- React ç»„ä»¶ï¼š>80%
- å·¥å…·å‡½æ•°ï¼š>95%

**æµ‹è¯•æ¡†æ¶ï¼š**
- Jest
- React Testing Library
- @testing-library/user-event

**ç¤ºä¾‹ï¼š**
```typescript
// __tests__/core/CommandManager.test.ts
describe('CommandManager', () => {
  it('should execute command', () => {
    const manager = new CommandManager()
    const mock = jest.fn()

    manager.register('test', mock)
    manager.execute('test')

    expect(mock).toHaveBeenCalled()
  })
})
```

### é›†æˆæµ‹è¯•

**æµ‹è¯•åœºæ™¯ï¼š**
1. å®Œæ•´ç¼–è¾‘æµç¨‹
2. è¡¨æ ¼æ“ä½œ
3. æµ®åŠ¨å›¾ç‰‡æ“ä½œ
4. æ’ä»¶äº¤äº’

**ç¤ºä¾‹ï¼š**
```typescript
// __tests__/integration/editor-flow.test.ts
describe('Editor Flow', () => {
  it('should complete full edit cycle', async () => {
    const { getByTestId, user } = render(<Editor />)

    // è¾“å…¥æ–‡æœ¬
    const editor = getByTestId('editor-area')
    await user.click(editor)
    await user.keyboard('Hello World')

    // åº”ç”¨æ ¼å¼
    await user.click(getByTestId('button-bold'))

    // éªŒè¯å†…å®¹
    expect(editor.innerHTML).toContain('<strong>Hello World</strong>')

    // æ’¤é”€
    await user.click(getByTestId('button-undo'))

    // éªŒè¯æ’¤é”€
    expect(editor.innerHTML).not.toContain('<strong>')
  })
})
```

### ç«¯åˆ°ç«¯æµ‹è¯•

**æµ‹è¯•æ¡†æ¶ï¼š** Playwright

**æµ‹è¯•åœºæ™¯ï¼š**
1. ç”¨æˆ·å®Œæ•´ä½¿ç”¨æµç¨‹
2. è·¨æµè§ˆå™¨å…¼å®¹æ€§
3. æ€§èƒ½æµ‹è¯•

**ç¤ºä¾‹ï¼š**
```typescript
// e2e/editor.spec.ts
test('full user workflow', async ({ page }) => {
  await page.goto('/editor')

  // è¾“å…¥å†…å®¹
  await page.fill('[data-testid="editor-area"]', 'Test Content')

  // åº”ç”¨æ ¼å¼
  await page.click('[data-testid="button-bold"]')

  // éªŒè¯
  await expect(page.locator('strong')).toContainText('Test Content')
})
```

---

## é£é™©ç®¡ç†

### é£é™©çŸ©é˜µ

| é£é™© | æ¦‚ç‡ | å½±å“ | ä¼˜å…ˆçº§ | åº”å¯¹æªæ–½ |
|------|------|------|--------|----------|
| åŠŸèƒ½é—æ¼ | ä¸­ | é«˜ | é«˜ | æµ‹è¯•ç”¨ä¾‹è¦†ç›– |
| æ€§èƒ½ä¸‹é™ | ä½ | ä¸­ | ä¸­ | æ€§èƒ½åŸºå‡†æµ‹è¯• |
| å…¼å®¹æ€§é—®é¢˜ | ä¸­ | é«˜ | é«˜ | æµè§ˆå™¨æµ‹è¯• |
| æ’ä»¶å†²çª | ä½ | ä¸­ | ä¸­ | éš”ç¦»æœºåˆ¶ |
| æ—¶é—´è¶…æœŸ | ä¸­ | é«˜ | é«˜ | åˆ†é˜¶æ®µäº¤ä»˜ |

### å…³é”®é£é™©åº”å¯¹

#### é£é™© 1ï¼šåŠŸèƒ½é—æ¼

**é¢„é˜²æªæ–½ï¼š**
- è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹æ¸…å•
- åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ
- ä»£ç å®¡æŸ¥

**æ£€æµ‹æ–¹æ³•ï¼š**
- è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- æ‰‹åŠ¨åŠŸèƒ½æµ‹è¯•
- ç”¨æˆ·éªŒæ”¶æµ‹è¯•

**åº”å¯¹æ–¹æ¡ˆï¼š**
- å‘ç°é—æ¼ç«‹å³è¡¥å……
- å»ºç«‹åŠŸèƒ½å›å½’æµ‹è¯•

#### é£é™© 2ï¼šæ€§èƒ½ä¸‹é™

**é¢„é˜²æªæ–½ï¼š**
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- ä»£ç æ€§èƒ½åˆ†æ
- ä¼˜åŒ–å…³é”®è·¯å¾„

**æ£€æµ‹æ–¹æ³•ï¼š**
- Lighthouse è¯„åˆ†
- æ¸²æŸ“æ€§èƒ½æµ‹è¯•
- å†…å­˜æ³„æ¼æ£€æµ‹

**åº”å¯¹æ–¹æ¡ˆï¼š**
- æ€§èƒ½é—®é¢˜ä¼˜å…ˆå¤„ç†
- ä½¿ç”¨ React.memoã€useMemo ä¼˜åŒ–
- è™šæ‹ŸåŒ–é•¿åˆ—è¡¨

#### é£é™© 3ï¼šå…¼å®¹æ€§é—®é¢˜

**é¢„é˜²æªæ–½ï¼š**
- æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
- Polyfill å¤„ç†
- æ¸è¿›å¢å¼º

**æ£€æµ‹æ–¹æ³•ï¼š**
- BrowserStack æµ‹è¯•
- çœŸæœºæµ‹è¯•
- è‡ªåŠ¨åŒ–å…¼å®¹æ€§æµ‹è¯•

**åº”å¯¹æ–¹æ¡ˆï¼š**
- ä½¿ç”¨æ ‡å‡† API
- æä¾› Polyfill
- é™çº§æ–¹æ¡ˆ

---

## æˆåŠŸæ ‡å‡†

### åŠŸèƒ½æ ‡å‡†

- [ ] æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] 209 ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
- [ ] æ–°å¢åŠŸèƒ½æœ‰æµ‹è¯•è¦†ç›–
- [ ] æ— å…³é”® Bug

### è´¨é‡æ ‡å‡†

- [ ] ä»£ç è¦†ç›–ç‡ >80%
- [ ] TypeScript ä¸¥æ ¼æ¨¡å¼é€šè¿‡
- [ ] ESLint æ— è­¦å‘Š
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

### å¯ç”¨æ€§æ ‡å‡†

- [ ] API æ–‡æ¡£å®Œæ•´
- [ ] ä½¿ç”¨ç¤ºä¾‹æ¸…æ™°
- [ ] è¿ç§»æŒ‡å—è¯¦ç»†
- [ ] æ’ä»¶å¼€å‘æŒ‡å—å®Œæ•´

### å‘å¸ƒæ ‡å‡†

- [ ] å¯ä»¥ä½œä¸ºç‹¬ç«‹åŒ…å‘å¸ƒ
- [ ] å¯ä»¥åœ¨é Next.js é¡¹ç›®ä½¿ç”¨
- [ ] æ”¯æŒä¸»æµæµè§ˆå™¨
- [ ] æœ‰å®Œæ•´çš„ CHANGELOG

---

## é™„å½•

### A. ä»£ç ç¤ºä¾‹

#### A.1 åŸºç¡€ä½¿ç”¨

```typescript
import { Editor } from '@your-org/editor'

function App() {
  const [content, setContent] = useState('')

  return (
    <Editor
      content={content}
      onContentChange={setContent}
      config={{
        toolbar: {
          position: 'top',
          rows: [/* ... */]
        }
      }}
      theme="light"
    />
  )
}
```

#### A.2 æ’ä»¶å¼€å‘

```typescript
import { Plugin } from '@your-org/editor'

export const MyPlugin: Plugin = {
  name: 'my-plugin',
  version: '1.0.0',

  install(api) {
    api.commands.register('myCommand', (doc) => {
      // å‘½ä»¤é€»è¾‘
    })

    api.toolbar.addButton({
      id: 'my-button',
      icon: MyIcon,
      tooltip: 'My Button',
      command: 'myCommand'
    })
  }
}
```

#### A.3 è‡ªå®šä¹‰ä¸»é¢˜

```typescript
import { Theme } from '@your-org/editor'

const customTheme: Theme = {
  name: 'custom',
  colors: {
    primary: '#custom-color',
    // ...
  },
  // ...
}

<Editor theme={customTheme} />
```

### B. è¿ç§»æ£€æŸ¥æ¸…å•

#### B.1 åŠŸèƒ½è¿ç§»

- [ ] åŸºç¡€ç¼–è¾‘åŠŸèƒ½
- [ ] æ–‡æœ¬æ ¼å¼åŒ–
- [ ] æ®µè½æ ¼å¼åŒ–
- [ ] åˆ—è¡¨æ”¯æŒ
- [ ] å›¾ç‰‡æ’å…¥
- [ ] æµ®åŠ¨å›¾ç‰‡
- [ ] è¡¨æ ¼ç¼–è¾‘
- [ ] é“¾æ¥æ’å…¥
- [ ] æ’¤é”€é‡åš
- [ ] æ ¼å¼åˆ·
- [ ] å¿«æ·é”®
- [ ] å·¥å…·æ 

#### B.2 é…ç½®è¿ç§»

- [ ] å­—ä½“é…ç½®
- [ ] å­—å·é…ç½®
- [ ] é¢œè‰²é…ç½®
- [ ] å›¾ç‰‡é™åˆ¶
- [ ] è¡¨æ ¼é™åˆ¶
- [ ] å†å²é…ç½®

#### B.3 æ ·å¼è¿ç§»

- [ ] å·¥å…·æ æ ·å¼
- [ ] æŒ‰é’®æ ·å¼
- [ ] ç¼–è¾‘åŒºåŸŸæ ·å¼
- [ ] æ‚¬æµ®å±‚æ ·å¼
- [ ] å“åº”å¼å¸ƒå±€

### C. æ€§èƒ½åŸºå‡†

#### C.1 åˆå§‹æ¸²æŸ“

- ç›®æ ‡ï¼š<100ms
- æµ‹è¯•ï¼šPerformance API

#### C.2 äº¤äº’å“åº”

- ç›®æ ‡ï¼š<50ms
- æµ‹è¯•ï¼šEvent Timing API

#### C.3 å†…å­˜å ç”¨

- ç›®æ ‡ï¼š<50MB
- æµ‹è¯•ï¼šChrome DevTools

---

## æ€»ç»“

æœ¬é‡æ„æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå…¨é¢çš„ã€åˆ†é˜¶æ®µçš„ Editor ç»„ä»¶é‡æ„è®¡åˆ’ã€‚é€šè¿‡å®æ–½æ­¤æ–¹æ¡ˆï¼Œæ‚¨å°†è·å¾—ï¼š

1. **å®Œå…¨ç‹¬ç«‹çš„ç¼–è¾‘å™¨ç»„ä»¶**ï¼šå¯åœ¨ä»»ä½• React é¡¹ç›®ä¸­ä½¿ç”¨
2. **æ’ä»¶åŒ–æ¶æ„**ï¼šæ˜“äºæ‰©å±•å’Œå®šåˆ¶
3. **é«˜åº¦å¯é…ç½®**ï¼šæ»¡è¶³å„ç§ä½¿ç”¨åœºæ™¯
4. **ä¸»é¢˜ç³»ç»Ÿ**ï¼šæ”¯æŒå¤šä¸»é¢˜å’Œè‡ªå®šä¹‰æ ·å¼
5. **å®Œå–„çš„æµ‹è¯•**ï¼šä¿è¯è´¨é‡å’Œç¨³å®šæ€§

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š**
1. è¯„å®¡æœ¬æ–¹æ¡ˆ
2. ç¡®å®šä¼˜å…ˆçº§å’Œæ—¶é—´è¡¨
3. ç»„å»ºé‡æ„å›¢é˜Ÿ
4. å¼€å§‹é˜¶æ®µ 1 å®æ–½

ç¥é‡æ„é¡ºåˆ©ï¼
