<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor 组件测试报告</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-passed { background-color: #10b981; }
    .status-failed { background-color: #ef4444; }
    .status-skipped { background-color: #f59e0b; }
    .status-pending { background-color: #6b7280; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    .progress-bar { transition: width 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
    .filter-btn.active { background-color: #3b82f6; color: white; }
    .coverage-excellent { color: #10b981; }
    .coverage-good { color: #22c55e; }
    .coverage-fair { color: #eab308; }
    .coverage-poor { color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app" class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Editor 组件测试报告</h1>
          <p class="text-gray-600 mt-1">实时测试状态与覆盖率追踪</p>
        </div>
        <div class="text-right">
          <p class="text-sm text-gray-500">最后更新</p>
          <p class="text-lg font-semibold text-gray-700" id="lastUpdate"></p>
        </div>
      </div>
    </header>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">总测试用例</p>
            <p class="text-3xl font-bold text-gray-900" id="totalTests">390</p>
          </div>
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">通过</p>
            <p class="text-3xl font-bold text-green-600" id="passedTests">372</p>
          </div>
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">跳过</p>
            <p class="text-3xl font-bold text-yellow-600" id="skippedTests">14</p>
          </div>
          <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6 card-hover transition-all duration-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">失败</p>
            <p class="text-3xl font-bold text-red-600" id="failedTests">4</p>
          </div>
          <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <div class="flex items-center justify-between mb-2">
        <span class="text-gray-700 font-medium">总体进度</span>
        <span class="text-gray-500 text-sm" id="progressPercent">95.4%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
        <div id="progressBar" class="progress-bar bg-gradient-to-r from-green-400 to-green-600 h-full rounded-full" style="width: 95.4%"></div>
      </div>
    </div>

    <!-- Coverage Summary -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">代码覆盖率 (Jest单元测试)</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="text-center">
          <p class="text-3xl font-bold text-blue-600" id="coverageLines">42.93%</p>
          <p class="text-sm text-gray-500">行覆盖率</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold text-purple-600" id="coverageStatements">43.03%</p>
          <p class="text-sm text-gray-500">语句覆盖率</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold text-pink-600" id="coverageFunctions">47.71%</p>
          <p class="text-sm text-gray-500">函数覆盖率</p>
        </div>
        <div class="text-center">
          <p class="text-3xl font-bold text-orange-600" id="coverageBranches">37.09%</p>
          <p class="text-sm text-gray-500">分支覆盖率</p>
        </div>
      </div>
      <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
        <p class="text-sm text-yellow-800">
          <strong>EditablePreview 组件覆盖率: 35.11% (行覆盖率)</strong><br>
          <span class="text-xs">该组件采用iframe架构，大部分逻辑在iframe内的事件处理器中执行。Playwright E2E测试(20/24通过)已在真实浏览器中验证组件功能，但E2E测试覆盖率不计入Jest报告。要达到90%覆盖率目标，需要设置Istanbul覆盖率收集或重构组件架构。</span>
        </p>
      </div>
    </div>

    <!-- Filter Buttons -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button onclick="filterTests('all')" class="filter-btn active px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors hover:bg-gray-50">全部</button>
      <button onclick="filterTests('passed')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors hover:bg-gray-50">已通过</button>
      <button onclick="filterTests('skipped')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors hover:bg-gray-50">已跳过</button>
      <button onclick="filterTests('failed')" class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition-colors hover:bg-gray-50">失败</button>
    </div>

    <!-- Test Suites -->
    <div id="testSuites" class="space-y-4">
      <!-- Test suites will be rendered here -->
    </div>

    <!-- Legend -->
    <div class="mt-8 p-4 bg-gray-100 rounded-lg">
      <h3 class="text-sm font-medium text-gray-700 mb-2">状态说明</h3>
      <div class="flex flex-wrap gap-4 text-sm">
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-green-500"></span>
          <span class="text-gray-600">通过</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
          <span class="text-gray-600">跳过 (jsdom 中不稳定)</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-red-500"></span>
          <span class="text-gray-600">失败</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="w-3 h-3 rounded-full bg-gray-500"></span>
          <span class="text-gray-600">未实现</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Test data
    const testData = {
      suites: [
        {
          name: 'EditablePreview (Jest单元测试)',
          file: '__tests__/components/editor/EditablePreview.test.tsx',
          total: 24,
          passed: 24,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P0',
          coverage: { lines: 35.11, statements: 33.84, functions: 39.39, branches: 24.07 },
          tests: '24个测试用例全部通过 - 使用真实iframe和事件',
          note: 'iframe架构限制导致Jest覆盖率仅35.11%。已通过Playwright E2E测试补充'
        },
        {
          name: 'EditablePreview (Playwright E2E测试)',
          file: 'e2e/editable-preview.spec.ts',
          total: 24,
          passed: 20,
          failed: 4,
          skipped: 0,
          status: 'failed',
          priority: 'P0',
          tests: '20个通过，4个失败 - 真实浏览器测试，覆盖滚动、选择、键盘、粘贴等24个场景',
          note: 'E2E测试不计入Jest覆盖率报告。失败用例为iframe元素定位问题'
        },
        {
          name: 'ImageResizer',
          file: 'test/editor/ImageResizer.test.tsx',
          total: 29,
          passed: 29,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P1',
          coverage: { lines: 100, statements: 100, functions: 100, branches: 97.14 },
          tests: '29个测试用例全部通过 - 100%覆盖率'
        },
        {
          name: 'FloatingImageLayer',
          file: 'test/editor/FloatingImageLayer.test.tsx',
          total: 23,
          passed: 23,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P1',
          coverage: { lines: 52.34, statements: 47.39, functions: 54.54, branches: 38.09 },
          tests: '23个测试用例全部通过 - 包含零高度图片高风险用例'
        },
        {
          name: 'useEditorCommands',
          file: 'test/editor/useEditorCommands.test.ts',
          total: 37,
          passed: 37,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P1',
          coverage: { lines: 79.31, statements: 77.68, functions: 94.36, branches: 54.6 },
          tests: '37个测试用例全部通过 - 包含格式刷高风险用例'
        },
        {
          name: 'TableSmartToolbar',
          file: 'test/editor/TableSmartToolbar.test.tsx',
          total: 45,
          passed: 45,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P2',
          coverage: { lines: 61.48, statements: 59.42, functions: 57.5, branches: 45.6 },
          tests: '45个测试用例全部通过 - 复杂表格交互'
        },
        {
          name: 'SmartContextMenu',
          file: 'components/editor/toolbar/SmartContextMenu.test.tsx',
          total: 31,
          passed: 17,
          failed: 0,
          skipped: 14,
          status: 'passed',
          priority: 'P1',
          coverage: { lines: 62.5, statements: 63.63, functions: 42.85, branches: 100 },
          note: '14个hover测试因jsdom限制被跳过',
          tests: '17个通过，14个跳过 - hover交互需要真实浏览器'
        },
        {
          name: '其他组件',
          file: 'multiple',
          total: 177,
          passed: 177,
          failed: 0,
          skipped: 0,
          status: 'passed',
          priority: 'P3',
          components: [
            { name: 'ColorPicker', total: 2, passed: 2, file: 'components/editor/toolbar/pickers/ColorPicker.test.tsx' },
            { name: 'ColorGrid', total: 2, passed: 2, file: 'components/editor/toolbar/pickers/ColorGrid.test.tsx' },
            { name: 'TablePicker', total: 4, passed: 4, file: 'components/editor/toolbar/pickers/TablePicker.test.tsx' },
            { name: 'ImagePicker', total: 3, passed: 3, file: 'components/editor/toolbar/pickers/ImagePicker.test.tsx' },
            { name: 'PickerDropdown', total: 3, passed: 3, file: 'components/editor/toolbar/pickers/PickerDropdown.test.tsx' },
            { name: 'ToolbarSelect', total: 2, passed: 2, file: 'components/editor/toolbar/inputs/ToolbarSelect.test.tsx' },
            { name: 'ButtonRenderer', total: 4, passed: 4, file: 'components/editor/toolbar/core/ButtonRenderer.test.tsx' },
            { name: 'useEditorState', total: 3, passed: 3, file: 'components/editor/toolbar/hooks/useEditorState.test.ts' },
            { name: 'EditorToolbar', total: 4, passed: 4, file: 'components/editor/EditorToolbar.test.tsx' },
            { name: 'useHistory', total: 5, passed: 5, file: '__tests__/components/editor/hooks/useHistory.test.ts' },
            { name: 'style utils', total: 2, passed: 2, file: '__tests__/components/editor/utils/style.test.ts' },
            { name: 'table utils', total: 12, passed: 12, file: 'components/editor/utils/table.test.ts' },
            { name: 'test examples', total: 135, passed: 135, file: 'test/examples/example.test.tsx', skipped: 0 }
          ]
        }
      ]
    };

    // Update timestamp
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');

    // Get coverage class
    function getCoverageClass(pct) {
      if (pct >= 80) return 'coverage-excellent';
      if (pct >= 60) return 'coverage-good';
      if (pct >= 40) return 'coverage-fair';
      return 'coverage-poor';
    }

    // Render test suites
    function renderTestSuites(filter = 'all') {
      const container = document.getElementById('testSuites');
      container.innerHTML = '';

      testData.suites.forEach(suite => {
        // Filter logic
        let shouldShow = true;
        if (filter === 'passed' && suite.status === 'failed') shouldShow = false;
        if (filter === 'failed' && suite.status !== 'failed') shouldShow = false;
        if (filter === 'skipped' && suite.skipped === 0) shouldShow = false;

        if (!shouldShow) return;

        const passPercent = suite.total > 0 ? Math.round((suite.passed / suite.total) * 100) : 0;
        const statusColor = suite.status === 'passed' ? 'green' : suite.status === 'failed' ? 'red' : 'yellow';

        // Coverage badge
        let coverageHtml = '';
        if (suite.coverage) {
          const lineClass = getCoverageClass(suite.coverage.lines);
          coverageHtml = `
            <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
              <div class="flex justify-between"><span class="text-gray-500">行:</span><span class="${lineClass} font-medium">${suite.coverage.lines}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">函数:</span><span class="${getCoverageClass(suite.coverage.functions)} font-medium">${suite.coverage.functions}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">语句:</span><span class="${getCoverageClass(suite.coverage.statements)} font-medium">${suite.coverage.statements}%</span></div>
              <div class="flex justify-between"><span class="text-gray-500">分支:</span><span class="${getCoverageClass(suite.coverage.branches)} font-medium">${suite.coverage.branches}%</span></div>
            </div>
          `;
        }

        const card = document.createElement('div');
        card.className = `bg-white rounded-lg shadow p-6 animate-fadeIn`;
        card.style.animationDelay = `${Math.random() * 0.2}s`;

        let testsHtml = '';
        if (typeof suite.tests === 'string') {
          testsHtml = `<p class="mt-4 text-sm text-gray-600">${suite.tests}</p>`;
        } else if (suite.components) {
          testsHtml = `
            <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
              ${suite.components.map(comp => `
                <div class="p-3 bg-gray-50 rounded">
                  <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-gray-800 text-sm">${comp.name}</span>
                    <span class="text-sm text-gray-600">${comp.passed}/${comp.total}</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-500 h-2 rounded-full" style="width: ${(comp.passed / comp.total) * 100}%"></div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        }

        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <h3 class="text-lg font-semibold text-gray-900">${suite.name}</h3>
                <span class="px-2 py-1 text-xs font-medium rounded bg-${statusColor}-100 text-${statusColor}-800">${suite.priority}</span>
                ${suite.note ? `<span class="text-xs text-yellow-600">⚠️ ${suite.note}</span>` : ''}
              </div>
              <p class="text-sm text-gray-500">${suite.file}</p>
            </div>
            <div class="text-right ml-4">
              <p class="text-2xl font-bold text-${statusColor}-600">${passPercent}%</p>
              <p class="text-xs text-gray-500">${suite.passed}/${suite.total}</p>
            </div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
            <div class="bg-${statusColor}-500 h-2 rounded-full transition-all duration-500" style="width: ${passPercent}%"></div>
          </div>
          ${coverageHtml}
          ${testsHtml}
        `;

        container.appendChild(card);
      });
    }

    // Filter tests
    function filterTests(filter) {
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Re-render
      renderTestSuites(filter);
    }

    // Initial render
    renderTestSuites();
  </script>
</body>
</html>
